<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG æ£€ç´¢ - LangChain 1.0 çŸ¥è¯†ç‚¹</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body class="chapter-retrieval">
    <button class="theme-toggle">ğŸŒ“</button>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>

    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1>LangChain 1.0</h1>
                <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-top: 5px;">çŸ¥è¯†ç‚¹</p>
            </div>
            <div class="sidebar-nav"></div>
        </nav>

        <main class="main-content">
            <div class="content">
                <h1>RAG æ£€ç´¢ (Retrieval)</h1>
                <p class="subtitle">æ£€ç´¢å¢å¼ºç”Ÿæˆ - æ–‡æ¡£é—®ç­”ç³»ç»Ÿ</p>

                <h2>ä»€ä¹ˆæ˜¯ RAGï¼Ÿ</h2>
                <p><strong>RAG (Retrieval-Augmented Generation)</strong> æ˜¯ä¸€ç§ç»“åˆæ£€ç´¢å’Œç”Ÿæˆçš„æŠ€æœ¯ï¼š</p>
                <ol>
                    <li>å°†æ–‡æ¡£åˆ†å‰²æˆå°å—å¹¶å‘é‡åŒ–</li>
                    <li>å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“</li>
                    <li>ç”¨æˆ·æŸ¥è¯¢æ—¶æ£€ç´¢ç›¸å…³æ–‡æ¡£</li>
                    <li>å°†æ£€ç´¢ç»“æœä½œä¸ºä¸Šä¸‹æ–‡ä¼ é€’ç»™ LLM</li>
                    <li>LLM åŸºäºä¸Šä¸‹æ–‡ç”Ÿæˆç­”æ¡ˆ</li>
                </ol>

                <pre class="mermaid">graph LR
    A[ç”¨æˆ·é—®é¢˜] --> B[å‘é‡åŒ–é—®é¢˜]
    C[æ–‡æ¡£åº“] --> D[å‘é‡å­˜å‚¨]
    B --> D
    D --> E[ç›¸ä¼¼åº¦æ£€ç´¢]
    E --> F[ç›¸å…³æ–‡æ¡£]
    F --> G[LLM + ä¸Šä¸‹æ–‡]
    G --> H[ç”Ÿæˆç­”æ¡ˆ]</code></pre>

                <h2>åŸºç¡€ RAG å®ç°</h2>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain_core.documents import Document
from langchain_chroma import Chroma
from langchain_openai import ChatOpenAI, OpenAIEmbeddings
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langchain_core.runnables import RunnablePassthrough

# 1. å‡†å¤‡æ–‡æ¡£
docs = [
    Document(page_content="LangChain æ˜¯ä¸€ä¸ªç”¨äºæ„å»º LLM åº”ç”¨çš„æ¡†æ¶"),
    Document(page_content="LCEL æ˜¯ LangChain çš„å£°æ˜å¼è¯­æ³•"),
    Document(page_content="Agents æ˜¯å¯ä»¥è‡ªä¸»å†³ç­–çš„ AI ç³»ç»Ÿ")
]

# 2. åˆ›å»ºå‘é‡å­˜å‚¨
embeddings = OpenAIEmbeddings()
vectorstore = Chroma.from_documents(docs, embeddings)
retriever = vectorstore.as_retriever(search_kwargs={"k": 2})

# 3. åˆ›å»ºæç¤ºæ¨¡æ¿
prompt = ChatPromptTemplate.from_template("""
æ ¹æ®ä»¥ä¸‹ä¸Šä¸‹æ–‡å›ç­”é—®é¢˜ï¼š

ä¸Šä¸‹æ–‡ï¼š
{context}

é—®é¢˜ï¼š{question}

ç­”æ¡ˆï¼š
""")

# 4. åˆ›å»º LLM
llm = ChatOpenAI(model="gpt-4o")

# 5. ç»„åˆ RAG é“¾
def format_docs(docs):
    return "\n\n".join([d.page_content for d in docs])

rag_chain = (
    {"context": retriever | format_docs, "question": RunnablePassthrough()}
    | prompt
    | llm
    | StrOutputParser()
)

# 6. æŸ¥è¯¢
result = rag_chain.invoke({"question": "ä»€ä¹ˆæ˜¯ LCELï¼Ÿ"})
print(result)</code></pre>
                </div>

                <h2>æ–‡æ¡£åŠ è½½å™¨</h2>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain_community.document_loaders import (
    TextLoader,
    PyPDFLoader,
    WebBaseLoader,
    DirectoryLoader
)

# åŠ è½½æ–‡æœ¬æ–‡ä»¶
text_loader = TextLoader("document.txt")
text_docs = text_loader.load()

# åŠ è½½ PDF
pdf_loader = PyPDFLoader("document.pdf")
pdf_docs = pdf_loader.load()

# åŠ è½½ç½‘é¡µ
web_loader = WebBaseLoader("https://example.com")
web_docs = web_loader.load()

# åŠ è½½æ•´ä¸ªç›®å½•
dir_loader = DirectoryLoader(
    "./documents",
    glob="**/*.txt",
    loader_cls=TextLoader
)
all_docs = dir_loader.load()</code></pre>
                </div>

                <h2>æ–‡æœ¬åˆ†å‰²å™¨</h2>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain_text_splitters import RecursiveCharacterTextSplitter

# åˆ›å»ºåˆ†å‰²å™¨
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=1000,          # æ¯å—å¤§å°
    chunk_overlap=200,         # é‡å å¤§å°
    length_function=len,
    separators=["\n\n", "\n", "ã€‚", "ï¼Œ", " ", ""]
)

# åˆ†å‰²æ–‡æ¡£
splits = text_splitter.split_documents(docs)
print(f"åŸå§‹æ–‡æ¡£: {len(docs)}")
print(f"åˆ†å‰²å: {len(splits)}")</code></pre>
                </div>

                <h2>æ··åˆæ£€ç´¢ (Hybrid Retrieval)</h2>

                <p>æ··åˆæ£€ç´¢ç»“åˆ<strong>å‘é‡æ£€ç´¢</strong>å’Œ<strong>å…³é”®è¯æ£€ç´¢</strong>ï¼ˆå¦‚ BM25ï¼‰ï¼Œæé«˜å¬å›ç‡ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain_community.retrievers import BM25Retriever
from langchain.retrievers import EnsembleRetriever
from langchain_chroma import Chroma
from langchain_openai import OpenAIEmbeddings

# å‡†å¤‡æ–‡æ¡£
docs = [
    Document(page_content="Python æ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€"),
    Document(page_content="JavaScript ä¸»è¦ç”¨äº Web å¼€å‘"),
    Document(page_content="Go è¯­è¨€ç”± Google å¼€å‘"),
    # ... æ›´å¤šæ–‡æ¡£
]

# 1. åˆ›å»ºå‘é‡æ£€ç´¢å™¨
embeddings = OpenAIEmbeddings()
vectorstore = Chroma.from_documents(docs, embeddings)
vector_retriever = vectorstore.as_retriever(search_kwargs={"k": 5})

# 2. åˆ›å»º BM25 å…³é”®è¯æ£€ç´¢å™¨
bm25_retriever = BM25Retriever.from_documents(docs, k=5)

# 3. åˆ›å»ºé›†æˆæ£€ç´¢å™¨ï¼ˆæ··åˆæ£€ç´¢ï¼‰
ensemble_retriever = EnsembleRetriever(
    retrievers=[bm25_retriever, vector_retriever],
    weights=[0.5, 0.5]  # BM25 å’Œå‘é‡å„å  50%
)

# ä½¿ç”¨æ··åˆæ£€ç´¢
query = "ç¼–ç¨‹è¯­è¨€"
results = ensemble_retriever.get_relevant_documents(query)

for doc in results:
    print(doc.page_content)</code></pre>
                </div>

                <pre class="mermaid">graph TD
    A[ç”¨æˆ·æŸ¥è¯¢] --> B[å‘é‡æ£€ç´¢]
    A --> C[BM25 æ£€ç´¢]
    B --> D[ç»“æœé›† 1]
    C --> E[ç»“æœé›† 2]
    D --> F[ç»“æœèåˆ RRF]
    E --> F
    F --> G[Top-K ç»“æœ]</code></pre>

                <div class="tip" data-label="æç¤º">
                    <strong>RRF (Reciprocal Rank Fusion)</strong> æ˜¯å¸¸ç”¨çš„ç»“æœèåˆç®—æ³•ï¼Œé€šè¿‡æ’åå€’æ•°åŠ æƒåˆå¹¶å¤šä¸ªæ£€ç´¢å™¨çš„ç»“æœã€‚
                </div>

                <h2>é‡æ’åº (Reranking)</h2>

                <p>é‡æ’åºä½¿ç”¨æ›´å¼ºçš„æ¨¡å‹å¯¹åˆæ­¥æ£€ç´¢ç»“æœè¿›è¡Œç²¾æ’ï¼Œæé«˜å‡†ç¡®ç‡ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain_community.cross_encoders import HuggingFaceCrossEncoder
from langchain.retrievers import ContextualCompressionRetriever

# 1. åˆ›å»ºåŸºç¡€æ£€ç´¢å™¨
retriever = vectorstore.as_retriever(search_kwargs={"k": 10})

# 2. åˆ›å»º Cross-Encoder Reranker
reranker = HuggingFaceCrossEncoder(
    model_name="BAAI/bge-reranker-base"
)

# 3. åˆ›å»ºå‹ç¼©æ£€ç´¢å™¨ï¼ˆå¸¦é‡æ’åºï¼‰
compression_retriever = ContextualCompressionRetriever(
    base_compressor=reranker,
    base_retriever=retriever
)

# 4. æ£€ç´¢å¹¶é‡æ’åº
query = "LangChain çš„ç”¨é€”"
results = compression_retriever.get_relevant_documents(query)

# è¿”å›é‡æ’åºåçš„ Top-K
for i, doc in enumerate(results):
    print(f"{i+1}. {doc.page_content}")</code></pre>
                </div>

                <div class="note" data-label="æ³¨æ„">
                    Cross-Encoder æ¨¡å‹ä¼šå¯¹æŸ¥è¯¢å’Œæ–‡æ¡£çš„é…å¯¹è¿›è¡Œæ‰“åˆ†ï¼Œæ¯”åŒå¡”æ¨¡å‹ï¼ˆå¦‚ Embeddingï¼‰æ›´å‡†ç¡®ï¼Œä½†é€Ÿåº¦è¾ƒæ…¢ã€‚é€šå¸¸å…ˆæ£€ç´¢å¤§é‡æ–‡æ¡£ï¼ˆå¦‚ k=50ï¼‰ï¼Œå†ç”¨ Reranker ç²¾æ’åˆ° Top-10ã€‚
                </div>

                <h2>Parent Document Retriever</h2>

                <p>çˆ¶å­æ–‡æ¡£æ£€ç´¢ç­–ç•¥ï¼šç”¨<strong>å°å—</strong>æ£€ç´¢ï¼Œè¿”å›<strong>å¤§å—</strong>ï¼ˆçˆ¶æ–‡æ¡£ï¼‰ï¼Œå…¼é¡¾ç²¾åº¦å’Œä¸Šä¸‹æ–‡å®Œæ•´æ€§ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain.retrievers import ParentDocumentRetriever
from langchain_chroma import Chroma
from langchain_openai import OpenAIEmbeddings
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain.storage import InMemoryStore

# 1. çˆ¶æ–‡æ¡£åˆ†å‰²å™¨ï¼ˆå¤§å—ï¼Œç”¨äºè¿”å›ï¼‰
parent_splitter = RecursiveCharacterTextSplitter(
    chunk_size=2000,
    chunk_overlap=200
)

# 2. å­æ–‡æ¡£åˆ†å‰²å™¨ï¼ˆå°å—ï¼Œç”¨äºæ£€ç´¢ï¼‰
child_splitter = RecursiveCharacterTextSplitter(
    chunk_size=400,
    chunk_overlap=50
)

# 3. å‘é‡å­˜å‚¨ï¼ˆå­˜å‚¨å­æ–‡æ¡£ï¼‰
vectorstore = Chroma(
    collection_name="full_documents",
    embedding_function=OpenAIEmbeddings()
)

# 4. æ–‡æ¡£å­˜å‚¨ï¼ˆå­˜å‚¨çˆ¶æ–‡æ¡£ï¼‰
store = InMemoryStore()

# 5. åˆ›å»º Parent Document Retriever
retriever = ParentDocumentRetriever(
    vectorstore=vectorstore,
    docstore=store,
    child_splitter=child_splitter,
    parent_splitter=parent_splitter
)

# 6. æ·»åŠ æ–‡æ¡£
retriever.add_documents(docs)

# 7. æ£€ç´¢ï¼šè¿”å›çˆ¶æ–‡æ¡£
query = "LangChain æ¡†æ¶"
results = retriever.get_relevant_documents(query)

# è¿”å›çš„æ˜¯çˆ¶æ–‡æ¡£ï¼ˆæ›´å¤§çš„ä¸Šä¸‹æ–‡ï¼‰
print(f"è¿”å›æ–‡æ¡£é•¿åº¦: {len(results[0].page_content)}")</code></pre>
                </div>

                <pre class="mermaid">graph LR
    A[åŸå§‹æ–‡æ¡£] --> B[çˆ¶åˆ†å‰²å™¨]
    B --> C[çˆ¶æ–‡æ¡£ 2000å­—]
    C --> D[å­åˆ†å‰²å™¨]
    D --> E[å­æ–‡æ¡£ 400å­—]
    E --> F[å‘é‡åŒ–]
    F --> G[å‘é‡æ£€ç´¢]
    G --> H[è¿”å›çˆ¶æ–‡æ¡£]</code></pre>

                <h2>Context Compression</h2>

                <p>ä¸Šä¸‹æ–‡å‹ç¼©ï¼šä½¿ç”¨ LLM æå–æ£€ç´¢æ–‡æ¡£ä¸­ä¸æŸ¥è¯¢ç›¸å…³çš„éƒ¨åˆ†ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain.retrievers import ContextualCompressionRetriever
from langchain.retrievers.document_compressors import LLMChainExtractor
from langchain_openai import ChatOpenAI

# 1. åŸºç¡€æ£€ç´¢å™¨
base_retriever = vectorstore.as_retriever(search_kwargs={"k": 5})

# 2. åˆ›å»ºå‹ç¼©å™¨ï¼ˆä½¿ç”¨ LLM æå–ç›¸å…³å†…å®¹ï¼‰
llm = ChatOpenAI(model="gpt-4o")
compressor = LLMChainExtractor.from_llm(llm)

# 3. åˆ›å»ºå‹ç¼©æ£€ç´¢å™¨
compression_retriever = ContextualCompressionRetriever(
    base_compressor=compressor,
    base_retriever=base_retriever
)

# 4. å‹ç¼©æ£€ç´¢
query = "ä»€ä¹ˆæ˜¯ LCELï¼Ÿ"
compressed_docs = compression_retriever.get_relevant_documents(query)

for doc in compressed_docs:
    print(f"å‹ç¼©å: {doc.page_content}")</code></pre>
                </div>

                <h2>Multi-Query Retriever</h2>

                <p>å¤šæŸ¥è¯¢æ£€ç´¢ï¼šè‡ªåŠ¨ç”Ÿæˆå¤šä¸ªæŸ¥è¯¢å˜ä½“ï¼Œæé«˜å¬å›ç‡ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain.retrievers import MultiQueryRetriever
from langchain_openai import ChatOpenAI

# 1. åˆ›å»ºåŸºç¡€æ£€ç´¢å™¨
base_retriever = vectorstore.as_retriever(search_kwargs={"k": 3})

# 2. åˆ›å»ºå¤šæŸ¥è¯¢æ£€ç´¢å™¨
llm = ChatOpenAI(model="gpt-4o")
multi_query_retriever = MultiQueryRetriever.from_llm(
    retriever=base_retriever,
    llm=llm
)

# 3. æŸ¥è¯¢ï¼šè‡ªåŠ¨ç”Ÿæˆå¤šä¸ªæŸ¥è¯¢å¹¶åˆå¹¶ç»“æœ
query = "å¦‚ä½•ä½¿ç”¨ LangChain æ„å»ºåº”ç”¨ï¼Ÿ"
results = multi_query_retriever.get_relevant_documents(query)

# ä¼šå»é‡åè¿”å›æ›´å¤šç›¸å…³ç»“æœ
print(f"æ£€ç´¢åˆ° {len(results)} ä¸ªç»“æœ")</code></pre>
                </div>

                <h2>MMR æ£€ç´¢ï¼ˆå¤šæ ·æ€§ï¼‰</h2>

                <p><strong>MMR (Max Marginal Relevance)</strong> åœ¨ç›¸å…³æ€§å’Œå¤šæ ·æ€§ä¹‹é—´å–å¾—å¹³è¡¡ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python"># åˆ›å»º MMR æ£€ç´¢å™¨
retriever = vectorstore.as_retriever(
    search_type="mmr",
    search_kwargs={
        "k": 5,              # è¿”å› 5 ä¸ªç»“æœ
        "fetch_k": 20,       # ä» 20 ä¸ªå€™é€‰ä¸­é€‰æ‹©
        "lambda_mult": 0.5   # 0.5 å¹³è¡¡ç›¸å…³æ€§å’Œå¤šæ ·æ€§
    }
)

# lambda_mult å‚æ•°è¯´æ˜ï¼š
# - 1.0: åªè€ƒè™‘ç›¸å…³æ€§ï¼ˆæ ‡å‡†æ£€ç´¢ï¼‰
# - 0.0: åªè€ƒè™‘å¤šæ ·æ€§
# - 0.5: å¹³è¡¡ä¸¤è€…ï¼ˆæ¨èï¼‰

results = retriever.get_relevant_documents("Python ç¼–ç¨‹")</code></pre>
                </div>

                <div class="tip" data-label="åº”ç”¨åœºæ™¯">
                    MMR ç‰¹åˆ«é€‚åˆä»¥ä¸‹åœºæ™¯ï¼šç”¨æˆ·éœ€è¦å¤šæ ·åŒ–çš„ä¿¡æ¯ã€é¿å…é‡å¤å†…å®¹ã€æ¢ç´¢æ€§æœç´¢ã€‚
                </div>

                <h2>æŸ¥è¯¢æ”¹å†™</h2>

                <p>ä½¿ç”¨ LLM æ”¹å†™ç”¨æˆ·æŸ¥è¯¢ï¼Œä½¿å…¶æ›´é€‚åˆæ£€ç´¢ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langchain_openai import ChatOpenAI

# æŸ¥è¯¢æ”¹å†™æç¤º
rewrite_prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€ä¸ªæŸ¥è¯¢æ”¹å†™ä¸“å®¶ã€‚å°†ç”¨æˆ·æŸ¥è¯¢æ”¹å†™ä¸ºæ›´é€‚åˆæ£€ç´¢çš„å½¢å¼ï¼Œä¿æŒåŸæ„ä¸å˜ã€‚"),
    ("user", "åŸå§‹æŸ¥è¯¢: {query}\n\næ”¹å†™åçš„æŸ¥è¯¢:")
])

# åˆ›å»ºæ”¹å†™é“¾
llm = ChatOpenAI(model="gpt-4o")
rewrite_chain = rewrite_prompt | llm | StrOutputParser()

# æ”¹å†™æŸ¥è¯¢
original_query = "LangChain æ€ä¹ˆæ"
rewritten_query = rewrite_chain.invoke({"query": original_query})

print(f"åŸå§‹: {original_query}")
print(f"æ”¹å†™: {rewritten_query}")
# è¾“å‡º: "å¦‚ä½•ä½¿ç”¨ LangChain æ¡†æ¶æ„å»ºåº”ç”¨"

# ä½¿ç”¨æ”¹å†™åçš„æŸ¥è¯¢æ£€ç´¢
results = vectorstore.similarity_search(rewritten_query, k=5)</code></pre>
                </div>

                <h2>RAG è¯„ä¼°ï¼ˆRAGASï¼‰</h2>

                <p>ä½¿ç”¨ RAGAS æ¡†æ¶è¯„ä¼° RAG ç³»ç»Ÿè´¨é‡ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from ragas import evaluate
from ragas.metrics import (
    faithfulness,    # å¿ å®åº¦ï¼šç­”æ¡ˆæ˜¯å¦åŸºäºæ£€ç´¢çš„ä¸Šä¸‹æ–‡
    answer_relevancy,  # ç›¸å…³æ€§ï¼šç­”æ¡ˆæ˜¯å¦å›ç­”äº†é—®é¢˜
    context_recall,    # å¬å›ç‡ï¼šæ£€ç´¢çš„ä¸Šä¸‹æ–‡æ˜¯å¦åŒ…å«å¿…è¦ä¿¡æ¯
    context_precision  # ç²¾ç¡®ç‡ï¼šæ£€ç´¢çš„ä¸Šä¸‹æ–‡æ˜¯å¦ç›¸å…³
)
from datasets import Dataset

# å‡†å¤‡è¯„ä¼°æ•°æ®
eval_data = {
    "question": [
        "ä»€ä¹ˆæ˜¯ LangChainï¼Ÿ",
        "LCEL æ˜¯ä»€ä¹ˆï¼Ÿ"
    ],
    "answer": [
        "LangChain æ˜¯ LLM åº”ç”¨æ¡†æ¶",
        "LCEL æ˜¯ LangChain çš„è¡¨è¾¾å¼è¯­è¨€"
    ],
    "contexts": [
        ["LangChain æ˜¯æ¡†æ¶...", "ç”¨äºæ„å»º LLM åº”ç”¨..."],
        ["LCEL æ˜¯å£°æ˜å¼è¯­æ³•...", "ä½¿ç”¨ | æ“ä½œç¬¦..."]
    ],
    "ground_truths": [
        "LangChain æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºå¤§è¯­è¨€æ¨¡å‹åº”ç”¨çš„æ¡†æ¶",
        "LCEL æ˜¯ LangChain Expression Languageï¼Œæ˜¯ä¸€ç§å£°æ˜å¼è¯­æ³•"
    ]
}

dataset = Dataset.from_dict(eval_data)

# è¿è¡Œè¯„ä¼°
result = evaluate(
    dataset,
    metrics=[
        faithfulness,
        answer_relevancy,
        context_recall,
        context_precision
    ]
)

# æŸ¥çœ‹ç»“æœ
print(result)

# è¾“å‡ºç¤ºä¾‹:
# faithfulness: 0.95
# answer_relevancy: 0.88
# context_recall: 0.92
# context_precision: 0.90</code></pre>
                </div>

                <pre class="mermaid">graph TD
    A[RAG è¯„ä¼°æŒ‡æ ‡] --> B[å¿ å®åº¦ Faithfulness]
    A --> C[ç›¸å…³æ€§ Relevancy]
    A --> D[å¬å›ç‡ Recall]
    A --> E[ç²¾ç¡®ç‡ Precision]
    B --> F[ç­”æ¡ˆæ˜¯å¦åŸºäºä¸Šä¸‹æ–‡]
    C --> G[ç­”æ¡ˆæ˜¯å¦å›ç­”é—®é¢˜]
    D --> H[ä¸Šä¸‹æ–‡æ˜¯å¦åŒ…å«å¿…è¦ä¿¡æ¯]
    E --> I[ä¸Šä¸‹æ–‡æ˜¯å¦ç›¸å…³]</code></pre>

                <div class="warning" data-label="è¯„ä¼°å»ºè®®">
                    å»ºè®®å®šæœŸè¯„ä¼° RAG ç³»ç»Ÿï¼Œç‰¹åˆ«æ˜¯åœ¨ä»¥ä¸‹æƒ…å†µï¼šæ·»åŠ æ–°æ–‡æ¡£ã€ä¿®æ”¹æ£€ç´¢ç­–ç•¥ã€æ›´æ¢ LLM æ¨¡å‹æ—¶ã€‚
                </div>

                <nav class="chapter-nav">
                    <a href="08-embeddings.html" class="prev">â† åµŒå…¥å‘é‡</a>
                    <a href="10-best-practices.html" class="next">æœ€ä½³å®è·µ â†’</a>
                </nav>

                <div class="exercise-section">
                    <h3>âœï¸ ç»ƒä¹ é¢˜</h3>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">é€‰æ‹©é¢˜</span>
                            1. æ··åˆæ£€ç´¢ä¸»è¦ç»“åˆå“ªä¸¤ç§æ£€ç´¢æ–¹å¼ï¼Ÿ
                        </div>
                        <div class="options">
                            <div class="option" onclick="this.classList.toggle('selected')">A. å‘é‡æ£€ç´¢ + å…¨æ–‡æ£€ç´¢</div>
                            <div class="option" onclick="this.classList.toggle('selected')">B. å‘é‡æ£€ç´¢ + BM25 å…³é”®è¯æ£€ç´¢</div>
                            <div class="option correct-option onclick="this.classList.toggle('selected')">B. å‘é‡æ£€ç´¢ + BM25 å…³é”®è¯æ£€ç´¢</div>
                            <div class="option" onclick="this.classList.toggle('selected')">C. BM25 + å…¨æ–‡æ£€ç´¢</div>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">é€‰æ‹©é¢˜</span>
                            2. Parent Document Retriever çš„ä¸»è¦ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ
                        </div>
                        <div class="options">
                            <div class="option correct-option onclick="this.classList.toggle('selected')">A. ç”¨å°å—æ£€ç´¢ï¼Œè¿”å›å¤§å—ï¼ˆçˆ¶æ–‡æ¡£ï¼‰</div>
                            <div class="option" onclick="this.classList.toggle('selected')">B. æé«˜æ£€ç´¢é€Ÿåº¦</div>
                            <div class="option" onclick="this.classList.toggle('selected')">C. å‡å°‘å­˜å‚¨ç©ºé—´</div>
                            <div class="option" onclick="this.classList.toggle('selected')">D. è‡ªåŠ¨æ–‡æ¡£ç”Ÿæˆ</div>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">é€‰æ‹©é¢˜</span>
                            3. MMR æ£€ç´¢ä¸­ lambda_mult=0.5 è¡¨ç¤ºä»€ä¹ˆï¼Ÿ
                        </div>
                        <div class="options">
                            <div class="option" onclick="this.classList.toggle('selected')">A. åªè€ƒè™‘ç›¸å…³æ€§</div>
                            <div class="option" onclick="this.classList.toggle('selected')">B. åªè€ƒè™‘å¤šæ ·æ€§</div>
                            <div class="option correct-option onclick="this.classList.toggle('selected')">C. å¹³è¡¡ç›¸å…³æ€§å’Œå¤šæ ·æ€§</div>
                            <div class="option" onclick="this.classList.toggle('selected')">D. å¿½ç•¥æ‰€æœ‰å› ç´ </div>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">ä»£ç å¡«ç©º</span>
                            4. è¡¥å…¨ä»¥ä¸‹æ··åˆæ£€ç´¢çš„ä»£ç 
                        </div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-language">python</span>
                            </div>
                            <pre><code class="language-python">from langchain.retrievers import EnsembleRetriever

ensemble_retriever = EnsembleRetriever(
    retrievers=[______, ______],
    weights=[0.5, 0.5]
)</code></pre>
                        </div>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: var(--primary-color);">æŸ¥çœ‹ç­”æ¡ˆ</summary>
                            <div style="margin-top: 10px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 5px;">
                                <code>bm25_retriever, vector_retriever</code>
                            </div>
                        </details>
                    </div>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">ç¼–ç¨‹é¢˜</span>
                            5. å®ç°ä¸€ä¸ªå®Œæ•´çš„ RAG æµç¨‹ï¼ŒåŒ…å«ï¼šæŸ¥è¯¢æ”¹å†™ â†’ æ··åˆæ£€ç´¢ â†’ Rerank
                        </div>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: var(--primary-color);">æŸ¥çœ‹å‚è€ƒç­”æ¡ˆ</summary>
                            <div class="code-block" style="margin-top: 10px;">
                                <div class="code-header">
                                    <span class="code-language">python</span>
                                    <button class="copy-btn">å¤åˆ¶</button>
                                </div>
                                <pre><code class="language-python">from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langchain.retrievers import EnsembleRetriever
from langchain_community.retrievers import BM25Retriever
from langchain_community.cross_encoders import HuggingFaceCrossEncoder
from langchain.retrievers import ContextualCompressionRetriever
from langchain_chroma import Chroma
from langchain_openai import ChatOpenAI, OpenAIEmbeddings

# 1. æŸ¥è¯¢æ”¹å†™é“¾
rewrite_prompt = ChatPromptTemplate.from_template("""
æ”¹å†™ä»¥ä¸‹æŸ¥è¯¢ï¼Œä½¿å…¶æ›´é€‚åˆæ£€ç´¢ï¼š
åŸå§‹æŸ¥è¯¢: {query}
æ”¹å†™æŸ¥è¯¢:
""")
llm = ChatOpenAI(model="gpt-4o")
rewrite_chain = rewrite_prompt | llm | StrOutputParser()

# 2. æ··åˆæ£€ç´¢å™¨
vectorstore = Chroma.from_documents(docs, OpenAIEmbeddings())
vector_retriever = vectorstore.as_retriever(search_kwargs={"k": 10})
bm25_retriever = BM25Retriever.from_documents(docs, k=10)
hybrid_retriever = EnsembleRetriever(
    retrievers=[bm25_retriever, vector_retriever],
    weights=[0.5, 0.5]
)

# 3. Reranker
reranker = HuggingFaceCrossEncoder(model_name="BAAI/bge-reranker-base")
rerank_retriever = ContextualCompressionRetriever(
    base_compressor=reranker,
    base_retriever=hybrid_retriever
)

# 4. å®Œæ•´æµç¨‹
query = "LangChain æ€ä¹ˆç”¨"
rewritten = rewrite_chain.invoke({"query": query})
results = rerank_retriever.get_relevant_documents(rewritten)</code></pre>
                            </div>
                        </details>
                    </div>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">åœºæ™¯é¢˜</span>
                            6. ä½ éœ€è¦ä¸ºä¸€ä¸ªä¼ä¸šæ„å»º RAG æ–‡æ¡£é—®ç­”ç³»ç»Ÿï¼Œå¤„ç† 10 ä¸‡ä»½æ–‡æ¡£ï¼Œè¦æ±‚å“åº”æ—¶é—´ < 3 ç§’ï¼Œå¦‚ä½•è®¾è®¡ï¼Ÿ
                        </div>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: var(--primary-color);">æŸ¥çœ‹å‚è€ƒæ–¹æ¡ˆ</summary>
                            <div style="margin-top: 15px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 10px;">
                                <strong>æ–¹æ¡ˆè¦ç‚¹ï¼š</strong>
                                <ul>
                                    <li><strong>å‘é‡æ•°æ®åº“</strong>ï¼šä½¿ç”¨ Chroma/FAISS å­˜å‚¨åµŒå…¥</li>
                                    <li><strong>æ··åˆæ£€ç´¢</strong>ï¼šç»“åˆå‘é‡ + BM25 æé«˜å‡†ç¡®ç‡</li>
                                    <li><strong>Rerank</strong>ï¼šå…ˆç”¨ BM25+å‘é‡å¬å› Top-50ï¼Œå†ç”¨ Reranker ç²¾æ’åˆ° Top-10</li>
                                    <li><strong>ç¼“å­˜å±‚</strong>ï¼šå¯¹å¸¸è§é—®é¢˜æ·»åŠ ç¼“å­˜</li>
                                    <li><strong>æµå¼è¾“å‡º</strong>ï¼šæ”¹å–„ç”¨æˆ·ä½“éªŒ</li>
                                    <li><strong>å¹¶å‘å¤„ç†</strong>ï¼šä½¿ç”¨ abatch æ‰¹é‡å¤„ç†è¯·æ±‚</li>
                                    <li><strong>ç›‘æ§</strong>ï¼šä½¿ç”¨ RAGAS å®šæœŸè¯„ä¼°è´¨é‡</li>
                                </ul>
                            </div>
                        </details>
                    </div>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">é€‰æ‹©é¢˜</span>
                            7. RAGAS æ¡†æ¶ä¸­çš„ faithfulness æŒ‡æ ‡è¡¡é‡ä»€ä¹ˆï¼Ÿ
                        </div>
                        <div class="options">
                            <div class="option" onclick="this.classList.toggle('selected')">A. æ£€ç´¢é€Ÿåº¦</div>
                            <div class="option correct-option onclick="this.classList.toggle('selected')">B. ç­”æ¡ˆæ˜¯å¦åŸºäºæ£€ç´¢çš„ä¸Šä¸‹æ–‡</div>
                            <div class="option" onclick="this.classList.toggle('selected')">C. æ£€ç´¢ç»“æœæ•°é‡</div>
                            <div class="option" onclick="this.classList.toggle('selected')">D. LLM æˆæœ¬</div>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">é€‰æ‹©é¢˜</span>
                            8. Context Compression çš„ä¸»è¦ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
                        </div>
                        <div class="options">
                            <div class="option" onclick="this.classList.toggle('selected')">A. å‹ç¼©æ–‡æ¡£å­˜å‚¨ç©ºé—´</div>
                            <div class="option" onclick="this.classList.toggle('selected')">B. åŠ å¿«æ£€ç´¢é€Ÿåº¦</div>
                            <div class="option correct-option onclick="this.classList.toggle('selected')">C. æå–æ£€ç´¢æ–‡æ¡£ä¸­ä¸æŸ¥è¯¢ç›¸å…³çš„å†…å®¹</div>
                            <div class="option" onclick="this.classList.toggle('selected')">D. å‡å°‘ LLM è°ƒç”¨æˆæœ¬</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="assets/js/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</body>
</html>
