<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®°å¿†ç®¡ç† - LangChain 1.0 çŸ¥è¯†ç‚¹</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body class="chapter-memory">
    <button class="theme-toggle">ğŸŒ“</button>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>

    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1><a href="../index.html" style="color: white; text-decoration: none;">LangChain 1.0</a></h1>
                <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-top: 5px;">çŸ¥è¯†ç‚¹</p>
            </div>
            <div class="sidebar-nav"></div>
        </nav>

        <main class="main-content">
            <div class="content">
                <h1>è®°å¿†ç®¡ç† (Memory)</h1>
                <p class="subtitle">ç»´æŠ¤å¯¹è¯ä¸Šä¸‹æ–‡å’Œå†å²</p>

                <h2>åŸºç¡€æ¶ˆæ¯å†å²</h2>

                <p>LangChain 1.0 ä½¿ç”¨ <code>InMemoryChatMessageHistory</code> ç®¡ç†å¯¹è¯å†å²ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain_core.messages import AIMessage, HumanMessage
from langchain_core.chat_history import InMemoryChatMessageHistory

# åˆ›å»ºå†å²è®°å½•
history = InMemoryChatMessageHistory()

# æ·»åŠ æ¶ˆæ¯
history.add_user_message("ä½ å¥½")
history.add_ai_message("ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„ï¼Ÿ")
history.add_user_message("ä½ çŸ¥é“ Python å—ï¼Ÿ")
history.add_ai_message("æ˜¯çš„ï¼ŒPython æ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€...")

# è·å–æ‰€æœ‰æ¶ˆæ¯
all_messages = history.messages
for msg in all_messages:
    print(f"{msg.type}: {msg.content}")

# æ¸…é™¤å†å²
history.clear()</code></pre>
                </div>

                <h2>ç»å…¸ Memory ç±»å‹</h2>

                <p>LangChain æä¾›å¤šç§ Memory ç±»å‹ï¼Œé€‚ç”¨äºä¸åŒåœºæ™¯ï¼š</p>

                <pre class="mermaid">graph TD
    A[Memory ç±»å‹é€‰æ‹©] --> B{å¯¹è¯é•¿åº¦}
    B -->|çŸ­å¯¹è¯| C[ConversationBufferMemory]
    B -->|é•¿å¯¹è¯| D{Token é™åˆ¶}
    D -->|æœ‰é™åˆ¶| E[ConversationTokenBufferMemory]
    D -->|æ— é™åˆ¶| F{éœ€è¦æ‘˜è¦?}
    F -->|æ˜¯| G[ConversationSummaryMemory]
    F -->|å¦| H[ConversationBufferWindowMemory]</code></pre>

                <h3>ConversationBufferMemory</h3>
                <p>æœ€ç®€å•çš„ Memory ç±»å‹ï¼Œç¼“å­˜æ‰€æœ‰å†å²æ¶ˆæ¯ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain.memory import ConversationBufferMemory
from langchain_openai import ChatOpenAI

# åˆ›å»º Buffer Memory
memory = ConversationBufferMemory(
    return_messages=True,  # è¿”å›æ¶ˆæ¯å¯¹è±¡è€Œéå­—ç¬¦ä¸²
    human_prefix="Human",
    ai_prefix="AI"
)

# ä¿å­˜ä¸Šä¸‹æ–‡
memory.save_context(
    {"input": "æˆ‘å«å¼ ä¸‰"},
    {"output": "ä½ å¥½å¼ ä¸‰ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï¼"}
)

memory.save_context(
    {"input": "æˆ‘å–œæ¬¢ç¼–ç¨‹"},
    {"output": "ç¼–ç¨‹æ˜¯ä¸€é¡¹å¾ˆæœ‰è¶£çš„æŠ€èƒ½"}
)

# åŠ è½½å†å²
history = memory.load_memory_variables({})
print(history["history"])</code></pre>
                </div>

                <h3>ConversationBufferWindowMemory</h3>
                <p>åªä¿ç•™æœ€è¿‘ K è½®å¯¹è¯ï¼Œè‡ªåŠ¨ä¸¢å¼ƒæ›´æ—©çš„æ¶ˆæ¯ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain.memory import ConversationBufferWindowMemory

# åˆ›å»ºçª—å£ Memoryï¼ˆä¿ç•™æœ€è¿‘ 3 è½®ï¼‰
memory = ConversationBufferWindowMemory(
    k=3,  # åªä¿ç•™æœ€è¿‘ 3 è½®å¯¹è¯
    return_messages=True
)

# æ·»åŠ  5 è½®å¯¹è¯
for i in range(5):
    memory.save_context(
        {"input": f"é—®é¢˜ {i}"},
        {"output": f"å›ç­” {i}"}
    )

# åªä¼šä¿ç•™æœ€è¿‘ 3 è½®ï¼ˆ2, 3, 4ï¼‰
history = memory.load_memory_variables({})
print(f"ä¿ç•™è½®æ•°: {len(history['history'])}")  # 6 æ¡æ¶ˆæ¯ = 3 è½®</code></pre>
                </div>

                <div class="tip" data-label="é€‚ç”¨åœºæ™¯">
                    ConversationBufferWindowMemory é€‚åˆï¼šToken é¢„ç®—æœ‰é™ã€ä¸éœ€è¦é•¿æœŸè®°å¿†çš„åœºæ™¯ã€‚
                </div>

                <h3>ConversationSummaryMemory</h3>
                <p>ä½¿ç”¨ LLM å¯¹å†å²è¿›è¡Œæ‘˜è¦å‹ç¼©ï¼ŒèŠ‚çœ Tokenï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain.memory import ConversationSummaryMemory
from langchain_openai import ChatOpenAI

# åˆ›å»ºæ‘˜è¦ Memory
llm = ChatOpenAI(model="gpt-4o")

memory = ConversationSummaryMemory(
    llm=llm,
    return_messages=True,
    max_token_limit=300  # æ‘˜è¦çš„æœ€å¤§ Token æ•°
)

# æ·»åŠ å¯¹è¯å†å²
memory.save_context(
    {"input": "æˆ‘å«å¼ ä¸‰ï¼Œæ˜¯ä¸€åè½¯ä»¶å·¥ç¨‹å¸ˆ"},
    {"output": "ä½ å¥½å¼ ä¸‰ï¼å¾ˆé«˜å…´è®¤è¯†ä¸€ä½è½¯ä»¶å·¥ç¨‹å¸ˆã€‚"}
)

memory.save_context(
    {"input": "æˆ‘ä¸»è¦ä½¿ç”¨ Python å’Œ Java å¼€å‘åç«¯æœåŠ¡"},
    {"output": "Python å’Œ Java éƒ½æ˜¯ä¼˜ç§€çš„åç«¯å¼€å‘è¯­è¨€ã€‚"}
)

# è·å–æ‘˜è¦
history = memory.load_memory_variables({})
print(history["history"])
# è¾“å‡º: SystemMessage(content="å¼ ä¸‰æ˜¯ä¸€ä½è½¯ä»¶å·¥ç¨‹å¸ˆï¼Œä¸»è¦ä½¿ç”¨ Python å’Œ Java è¿›è¡Œåç«¯å¼€å‘...")

# ç»§ç»­å¯¹è¯æ—¶ï¼Œæ‘˜è¦ä¼šè‡ªåŠ¨æ›´æ–°
memory.save_context(
    {"input": "æˆ‘æœ€è¿‘åœ¨å­¦ä¹  LangChain"},
    {"output": "LangChain æ˜¯ä¸€ä¸ªç”¨äºæ„å»º LLM åº”ç”¨çš„æ¡†æ¶ï¼Œå¾ˆé€‚åˆä½ å­¦ä¹ ï¼"}
)</code></pre>
                </div>

                <div class="note" data-label="æ‘˜è¦ç­–ç•¥">
                    ConversationSummaryMemory ä¼šè‡ªåŠ¨å°†æ—§å¯¹è¯åˆå¹¶ä¸ºæ‘˜è¦ï¼Œæ–°å¯¹è¯ä¿æŒåŸå§‹å½¢å¼ã€‚è¿™æ ·æ—¢ä¿ç•™äº†å…³é”®ä¿¡æ¯ï¼ŒåˆèŠ‚çœäº† Tokenã€‚
                </div>

                <h3>ConversationTokenBufferMemory</h3>
                <p>åŸºäº Token é™åˆ¶çš„æ»‘åŠ¨çª—å£ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain.memory import ConversationTokenBufferMemory
from langchain_openai import ChatOpenAI

llm = ChatOpenAI(model="gpt-4o")

# åˆ›å»º Token é™åˆ¶ Memory
memory = ConversationTokenBufferMemory(
    llm=llm,
    max_token_limit=500,  # æœ€å¤šä¿ç•™ 500 tokens
    return_messages=True
)

# æ·»åŠ å¯¹è¯ï¼ˆä¼šè‡ªåŠ¨è£å‰ªä»¥ç¬¦åˆ Token é™åˆ¶ï¼‰
for i in range(10):
    memory.save_context(
        {"input": f"é—®é¢˜ {i}" * 20},
        {"output": f"å›ç­” {i}" * 20}
    )

# ä¼šè¢«è£å‰ªåˆ°çº¦ 500 tokens
history = memory.load_memory_variables({})
print(f"å½“å‰ Token æ•°: {llm.get_num_tokens_from_messages(history['history'])}")</code></pre>
                </div>

                <h2>RunnableWithMessageHistoryï¼ˆv1.0 æ¨èï¼‰</h2>

                <p>LangChain 1.0 æ¨èä½¿ç”¨ <code>RunnableWithMessageHistory</code> ç®¡ç†å¯¹è¯å†å²ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain_core.runnables.history import RunnableWithMessageHistory
from langchain_core.chat_history import InMemoryChatMessageHistory
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_openai import ChatOpenAI
from langchain_core.output_parsers import StrOutputParser

# å­˜å‚¨å¤šä¸ªä¼šè¯çš„å†å²
store = {}

def get_session_history(session_id: str):
    """è·å–æˆ–åˆ›å»ºä¼šè¯å†å²"""
    if session_id not in store:
        store[session_id] = InMemoryChatMessageHistory()
    return store[session_id]

# åˆ›å»ºå¸¦å†å²çš„æç¤ºæ¨¡æ¿
prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„åŠ©æ‰‹ã€‚è¯·è®°ä½ç”¨æˆ·å‘Šè¯‰ä½ çš„ä¿¡æ¯ã€‚"),
    MessagesPlaceholder(variable="chat_history"),  # å†å²æ¶ˆæ¯å ä½ç¬¦
    ("user", "{input}")
])

# åˆ›å»ºé“¾
llm = ChatOpenAI(model="gpt-4o")
chain = prompt | llm | StrOutputParser()

# åŒ…è£…ä¸ºæ”¯æŒå†å²çš„å¯è¿è¡Œå¯¹è±¡
with_history = RunnableWithMessageHistory(
    chain,
    get_session_history,
    input_messages_key="input",
    history_messages_key="chat_history"
)

# ä½¿ç”¨ï¼šä¸åŒ session_id ç‹¬ç«‹
response1 = with_history.invoke(
    {"input": "ä½ å¥½ï¼Œæˆ‘å«å°æ˜"},
    config={"configurable": {"session_id": "user-123"}}
)
print(response1)  # ä½ å¥½å°æ˜ï¼

response2 = with_history.invoke(
    {"input": "æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ"},
    config={"configurable": {"session_id": "user-123"}}
)
print(response2)  # ä½ å«å°æ˜

# ä¸åŒ session_id ä¸å…±äº«å†å²
response3 = with_history.invoke(
    {"input": "æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ"},
    config={"configurable": {"session_id": "user-456"}}
)
print(response3)  # æˆ‘ä¸çŸ¥é“ä½ çš„åå­—</code></pre>
                </div>

                <div class="tip" data-label="v1.0 æ¨èæ–¹å¼">
                    RunnableWithMessageHistory æ˜¯ LangChain 1.0 æ¨èçš„æ–¹å¼ï¼Œå®ƒï¼š
                    <br>â€¢ ä¸ LCEL æ— ç¼é›†æˆ
                    <br>â€¢ æ”¯æŒå¤šä¼šè¯ç®¡ç†
                    <br>â€¢ è‡ªåŠ¨å¤„ç†å†å²ä¿å­˜å’ŒåŠ è½½
                </div>

                <h2>æŒä¹…åŒ–å­˜å‚¨</h2>

                <h3>Redis æŒä¹…åŒ–ï¼ˆè¯¦ç»†é…ç½®ï¼‰</h3>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain_core.chat_history import RedisChatMessageHistory
import redis

# æ–¹å¼ä¸€ï¼šåŸºç¡€è¿æ¥
history = RedisChatMessageHistory(
    session_id="user-session-123",
    url="redis://localhost:6379/0",
    ttl=3600  # 1 å°æ—¶è¿‡æœŸ
)

# æ–¹å¼äºŒï¼šä½¿ç”¨è¿æ¥æ± ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰
redis_pool = redis.ConnectionPool(
    host='localhost',
    port=6379,
    db=0,
    decode_responses=True,
    max_connections=50,
    socket_connect_timeout=5,
    socket_timeout=5
)

history = RedisChatMessageHistory(
    session_id="user-session-456",
    redis_pool=redis_pool,
    ttl=7200,  # 2 å°æ—¶è¿‡æœŸ
    key_prefix="langchain:chat:"  # é”®å‰ç¼€
)

# ä½¿ç”¨æ–¹å¼ä¸å†…å­˜ç‰ˆæœ¬ç›¸åŒ
history.add_user_message("ä½ å¥½")
history.add_ai_message("ä½ å¥½ï¼")
messages = history.messages</code></pre>
                </div>

                <h3>PostgreSQL æŒä¹…åŒ–ï¼ˆè¯¦ç»†é…ç½®ï¼‰</h3>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain_core.chat_history import PostgreSQLChatMessageHistory

# æ–¹å¼ä¸€ï¼šåŒæ­¥è¿æ¥
history = PostgreSQLChatMessageHistory(
    connection_string="postgresql://user:pass@localhost:5432/langchain",
    session_id="user-session-789",
    table_name="chat_history"  # è‡ªå®šä¹‰è¡¨å
)

# æ–¹å¼äºŒï¼šå¼‚æ­¥è¿æ¥ï¼ˆæ¨èï¼‰
history = PostgreSQLChatMessageHistory(
    connection_string="postgresql+asyncpg://user:pass@localhost:5432/langchain",
    session_id="user-session-abc",
    table_name="chat_history",
    create_table=True,  # è‡ªåŠ¨åˆ›å»ºè¡¨
    ttl=3600  # 1 å°æ—¶è¿‡æœŸ
)

# ä½¿ç”¨
history.add_user_message("Hello")
history.add_ai_message("Hi!")
messages = history.messages</code></pre>
                </div>

                <pre class="mermaid">graph TD
    A[ç”¨æˆ·æ¶ˆæ¯] --> B[RunnableWithMessageHistory]
    B --> C[è·å– session_id]
    C --> D{ä¼šè¯å­˜åœ¨?}
    D -->|æ˜¯| E[åŠ è½½å†å²]
    D -->|å¦| F[åˆ›å»ºæ–°ä¼šè¯]
    E --> G[æ„å»ºå®Œæ•´æ¶ˆæ¯]
    F --> G
    G --> H[è°ƒç”¨ LLM]
    H --> I[ä¿å­˜æ–°æ¶ˆæ¯]
    I --> J[Redis/PostgreSQL]
    J --> K[è¿”å›å“åº”]</code></pre>

                <h2>è®°å¿†å‹ç¼©ç­–ç•¥</h2>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain.memory import ConversationSummaryMemory
from langchain_openai import ChatOpenAI
from langchain_core.prompts import PromptTemplate

llm = ChatOpenAI(model="gpt-4o")

# è‡ªå®šä¹‰æ‘˜è¦æç¤º
summary_prompt = PromptTemplate(
    input_variables=["summary", "new_lines"],
    template="""å°†ä»¥ä¸‹å¯¹è¯å†å²å‹ç¼©ä¸ºç®€æ´çš„æ‘˜è¦ï¼š

å½“å‰æ‘˜è¦: {summary}

æ–°å¯¹è¯:
{new_lines}

è¯·ç”Ÿæˆæ–°çš„æ‘˜è¦ï¼ˆä¿ç•™å…³é”®ä¿¡æ¯ï¼Œå»é™¤é‡å¤ï¼‰:"""
)

memory = ConversationSummaryMemory(
    llm=llm,
    prompt=summary_prompt,
    max_token_limit=500,
    return_messages=True
)

# æ‰¹é‡æ·»åŠ å†å²
conversations = [
    ("æˆ‘å«å¼ ä¸‰", "ä½ å¥½å¼ ä¸‰ï¼"),
    ("æˆ‘æ˜¯ä¸€åå·¥ç¨‹å¸ˆ", "å·¥ç¨‹å¸ˆæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èŒä¸šã€‚"),
    ("æˆ‘åœ¨åŒ—äº¬å·¥ä½œ", "åŒ—äº¬æ˜¯ä¸­å›½çš„é¦–éƒ½ã€‚"),
    ("æˆ‘å–œæ¬¢ç¼–ç¨‹", "ç¼–ç¨‹æ˜¯å¾ˆæœ‰è¶£çš„æŠ€èƒ½ã€‚"),
    ("æˆ‘ä¸»è¦ç”¨ Python", "Python æ˜¯ä¸€é—¨ä¼˜ç§€çš„è¯­è¨€ã€‚"),
]

for user_msg, ai_msg in conversations:
    memory.save_context(
        {"input": user_msg},
        {"output": ai_msg}
    )

# è·å–å‹ç¼©åçš„æ‘˜è¦
history = memory.load_memory_variables({})
print(history["history"])
# è¾“å‡º: å¼ ä¸‰æ˜¯ä¸€ååœ¨åŒ—äº¬å·¥ä½œçš„å·¥ç¨‹å¸ˆï¼Œä¸»è¦ä½¿ç”¨ Python è¿›è¡Œç¼–ç¨‹å¼€å‘...</code></pre>
                </div>

                <h2>å¤šä¼šè¯ç®¡ç†</h2>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain_core.runnables.history import RunnableWithMessageHistory
from langchain_core.chat_history import InMemoryChatMessageHistory
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder

# å¤šä¼šè¯å­˜å‚¨
sessions = {}

def get_session_history(session_id: str):
    if session_id not in sessions:
        sessions[session_id] = InMemoryChatMessageHistory()
    return sessions[session_id]

prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„åŠ©æ‰‹ã€‚"),
    MessagesPlaceholder(variable="chat_history"),
    ("user", "{input}")
])

llm = ChatOpenAI(model="gpt-4o")
chain = prompt | llm
with_history = RunnableWithMessageHistory(
    chain,
    get_session_history,
    input_messages_key="input",
    history_messages_key="chat_history"
)

# æ¨¡æ‹Ÿå¤šä¸ªç”¨æˆ·åŒæ—¶å¯¹è¯
users = ["alice", "bob", "charlie"]
for user in users:
    response = with_history.invoke(
        {"input": f"ä½ å¥½ï¼Œæˆ‘æ˜¯ {user}"},
        config={"configurable": {"session_id": user}}
    )
    print(f"{user}: {response}")

# æ¯ä¸ªç”¨æˆ·çš„ä¼šè¯æ˜¯ç‹¬ç«‹çš„
for user in users:
    response = with_history.invoke(
        {"input": "æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ"},
        config={"configurable": {"session_id": user}}
    )
    print(f"{user} è®°å¾—è‡ªå·±çš„åå­—: {response}")</code></pre>
                </div>

                <nav class="chapter-nav">
                    <a href="06-tools.html" class="prev">â† å·¥å…·ç³»ç»Ÿ</a>
                    <a href="08-embeddings.html" class="next">åµŒå…¥å‘é‡ â†’</a>
                </nav>

                <div class="exercise-section">
                    <h3>âœï¸ ç»ƒä¹ é¢˜</h3>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">é€‰æ‹©é¢˜</span>
                            1. å“ªç§ Memory ç±»å‹é€‚åˆ Token æœ‰é™çš„åœºæ™¯ï¼Ÿ
                        </div>
                        <div class="options">
                            <div class="option" onclick="this.classList.toggle('selected')">A. ConversationBufferMemory</div>
                            <div class="option" onclick="this.classList.toggle('selected')">B. ConversationBufferWindowMemory</div>
                            <div class="option correct-option onclick="this.classList.toggle('selected')">C. ConversationTokenBufferMemory</div>
                            <div class="option" onclick="this.classList.toggle('selected')">D. ConversationKGMemory</div>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">é€‰æ‹©é¢˜</span>
                            2. RunnableWithMessageHistory çš„ä¸»è¦ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
                        </div>
                        <div class="options">
                            <div class="option" onclick="this.classList.toggle('selected')">A. å‹ç¼©å¯¹è¯å†å²</div>
                            <div class="option correct-option onclick="this.classList.toggle('selected')">B. ä¸ºé“¾æ·»åŠ å¯¹è¯å†å²ç®¡ç†</div>
                            <div class="option" onclick="this.classList.toggle('selected')">C. å­˜å‚¨ç”¨æˆ·é…ç½®</div>
                            <div class="option" onclick="this.classList.toggle('selected')">D. åŠ é€Ÿ LLM æ¨ç†</div>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">é€‰æ‹©é¢˜</span>
                            3. ConversationBufferWindowMemory çš„ k=3 è¡¨ç¤ºä»€ä¹ˆï¼Ÿ
                        </div>
                        <div class="options">
                            <div class="option" onclick="this.classList.toggle('selected')">A. ä¿ç•™ 3 æ¡æ¶ˆæ¯</div>
                            <div class="option correct-option onclick="this.classList.toggle('selected')">B. ä¿ç•™æœ€è¿‘ 3 è½®å¯¹è¯</div>
                            <div class="option" onclick="this.classList.toggle('selected')">C. ä¿ç•™ 3 ä¸ª Token</div>
                            <div class="option" onclick="this.classList.toggle('selected')">D. ä¿ç•™ 3 å¤©å†å²</div>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">é€‰æ‹©é¢˜</span>
                            4. ConversationSummaryMemory çš„æ‘˜è¦ç”±è°ç”Ÿæˆï¼Ÿ
                        </div>
                        <div class="options">
                            <div class="option" onclick="this.classList.toggle('selected')">A. è§„åˆ™æ¨¡æ¿</div>
                            <div class="option" onclick="this.classList.toggle('selected')">B. ç»Ÿè®¡ç®—æ³•</div>
                            <div class="option correct-option onclick="this.classList.toggle('selected')">C. LLM ç”Ÿæˆ</div>
                            <div class="option" onclick="this.classList.toggle('selected')">D. ç”¨æˆ·æ‰‹åŠ¨ç¼–å†™</div>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">ä»£ç å¡«ç©º</span>
                            5. è¡¥å…¨ RunnableWithMessageHistory çš„é…ç½®
                        </div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-language">python</span>
                            </div>
                            <pre><code class="language-python">with_history = RunnableWithMessageHistory(
    chain,
    get_session_history,
    input_messages_key="______",
    history_messages_key="______"
)</code></pre>
                        </div>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: var(--primary-color);">æŸ¥çœ‹ç­”æ¡ˆ</summary>
                            <div style="margin-top: 10px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 5px;">
                                <code>input</code> å’Œ <code>chat_history</code>
                            </div>
                        </details>
                    </div>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">é€‰æ‹©é¢˜</span>
                            6. Redis æŒä¹…åŒ–ä¸­çš„ ttl å‚æ•°è¡¨ç¤ºä»€ä¹ˆï¼Ÿ
                        </div>
                        <div class="options">
                            <div class="option" onclick="this.classList.toggle('selected')">A. æ€» Token æ•°</div>
                            <div class="option" onclick="this.classList.toggle('selected')">B. æœ€å¤§è¿æ¥æ•°</div>
                            <div class="option correct-option onclick="this.classList.toggle('selected')">C. è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰</div>
                            <div class="option" onclick="this.classList.toggle('selected')">D. è¶…æ—¶æ—¶é—´</div>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">ç¼–ç¨‹é¢˜</span>
                            7. å®ç°ä¸€ä¸ªä½¿ç”¨ Redis æŒä¹…åŒ–çš„å¤šè½®å¯¹è¯ç³»ç»Ÿ
                        </div>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: var(--primary-color);">æŸ¥çœ‹å‚è€ƒç­”æ¡ˆ</summary>
                            <div class="code-block" style="margin-top: 10px;">
                                <div class="code-header">
                                    <span class="code-language">python</span>
                                    <button class="copy-btn">å¤åˆ¶</button>
                                </div>
                                <pre><code class="language-python">from langchain_core.runnables.history import RunnableWithMessageHistory
from langchain_core.chat_history import RedisChatMessageHistory
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
import redis

# Redis è¿æ¥æ± 
redis_pool = redis.ConnectionPool(
    host='localhost',
    port=6379,
    db=0,
    decode_responses=True,
    max_connections=50
)

def get_session_history(session_id: str):
    return RedisChatMessageHistory(
        session_id=session_id,
        redis_pool=redis_pool,
        ttl=3600
    )

# åˆ›å»ºå¸¦å†å²çš„é“¾
prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„åŠ©æ‰‹ã€‚"),
    MessagesPlaceholder(variable="chat_history"),
    ("user", "{input}")
])

llm = ChatOpenAI(model="gpt-4o")
chain = prompt | llm

with_history = RunnableWithMessageHistory(
    chain,
    get_session_history,
    input_messages_key="input",
    history_messages_key="chat_history"
)

# ä½¿ç”¨
while True:
    user_input = input("ç”¨æˆ·: ")
    if user_input.lower() == 'exit':
        break

    response = with_history.invoke(
        {"input": user_input},
        config={"configurable": {"session_id": "user-123"}}
    )
    print(f"åŠ©æ‰‹: {response.content}")</code></pre>
                            </div>
                        </details>
                    </div>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">åœºæ™¯é¢˜</span>
                            8. ä½ éœ€è¦ä¸ºä¸€ä¸ªå¤§å®¢æœç³»ç»Ÿè®¾è®¡è®°å¿†æ–¹æ¡ˆï¼Œæ¯å¤©å¤„ç† 10 ä¸‡ç”¨æˆ·å¯¹è¯ï¼Œå¦‚ä½•è®¾è®¡ï¼Ÿ
                        </div>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: var(--primary-color);">æŸ¥çœ‹å‚è€ƒæ–¹æ¡ˆ</summary>
                            <div style="margin-top: 15px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 10px;">
                                <strong>æ–¹æ¡ˆè¦ç‚¹ï¼š</strong>
                                <ul>
                                    <li><strong>æŒä¹…åŒ–å­˜å‚¨</strong>ï¼šä½¿ç”¨ Redis Cluster å­˜å‚¨ä¼šè¯å†å²ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•</li>
                                    <li><strong>Memory ç±»å‹</strong>ï¼šConversationBufferWindowMemory(k=10) + å¼‚æ­¥æ‘˜è¦åˆ°é•¿æœŸå­˜å‚¨</li>
                                    <li><strong>TTL ç­–ç•¥</strong>ï¼šæ´»è·ƒä¼šè¯ 24 å°æ—¶è¿‡æœŸï¼Œéæ´»è·ƒä¼šè¯ 2 å°æ—¶</li>
                                    <li><strong>æ‘˜è¦å½’æ¡£</strong>ï¼šè¶…è¿‡ 20 è½®çš„å¯¹è¯è‡ªåŠ¨æ‘˜è¦å¹¶å­˜å…¥ PostgreSQL</li>
                                    <li><strong>å†·çƒ­åˆ†ç¦»</strong>ï¼šæœ€è¿‘ 10 è½®åœ¨ Redisï¼Œæ›´æ—©çš„æ‘˜è¦åœ¨æ•°æ®åº“</li>
                                    <li><strong>ä¼šè¯æ¸…ç†</strong>ï¼šå®šæ—¶ä»»åŠ¡æ¸…ç†è¿‡æœŸä¼šè¯ï¼Œé‡Šæ”¾å†…å­˜</li>
                                </ul>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../assets/js/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</body>
</html>
