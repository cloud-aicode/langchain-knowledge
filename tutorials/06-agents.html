<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ä½“ - LangChain 1.0 çŸ¥è¯†ç‚¹</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body class="chapter-agents">
    <button class="theme-toggle">ğŸŒ“</button>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>

    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1><a href="../index.html" style="color: white; text-decoration: none;">LangChain 1.0</a></h1>
                <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-top: 5px;">çŸ¥è¯†ç‚¹</p>
            </div>
            <div class="sidebar-nav"></div>
        </nav>

        <main class="main-content">
            <div class="content">
                <h1>æ™ºèƒ½ä½“ (Agents)</h1>
                <p class="subtitle">è‡ªä¸»å†³ç­–çš„ AI æ™ºèƒ½ä½“ç³»ç»Ÿ</p>

                <h2>ä»€ä¹ˆæ˜¯æ™ºèƒ½ä½“ï¼Ÿ</h2>
                <p>æ™ºèƒ½ä½“æ˜¯ LLM åº”ç”¨ï¼Œèƒ½å¤Ÿï¼š</p>
                <ul>
                    <li><strong>æ¨ç†</strong>ï¼šåˆ†æç”¨æˆ·æ„å›¾å¹¶è§„åˆ’è¡ŒåŠ¨æ­¥éª¤</li>
                    <li><strong>å†³ç­–</strong>ï¼šé€‰æ‹©åˆé€‚çš„å·¥å…·æ¥å®Œæˆä»»åŠ¡</li>
                    <li><strong>æ‰§è¡Œ</strong>ï¼šè°ƒç”¨å·¥å…·å¹¶å¤„ç†ç»“æœ</li>
                    <li><strong>è¿­ä»£</strong>ï¼šæ ¹æ®ç»“æœè°ƒæ•´ç­–ç•¥ï¼ŒæŒç»­ç›´åˆ°å®Œæˆç›®æ ‡</li>
                </ul>

                <h2>LangChain 1.0 æ™ºèƒ½ä½“ API</h2>

                <h3>åˆ›å»ºæ™ºèƒ½ä½“</h3>
                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain import ChatOpenAI
from langchain.agents import create_tool_calling_agent
from langchain_core.tools import tool

# 1. å®šä¹‰å·¥å…·
@tool
def search(query: str) -> str:
    """æœç´¢ç½‘ç»œä¿¡æ¯"""
    return f"å…³äº '{query}' çš„æœç´¢ç»“æœ..."

@tool
def calculate(expression: str) -> str:
    """è®¡ç®—æ•°å­¦è¡¨è¾¾å¼"""
    try:
        return f"ç»“æœ: {eval(expression)}"
    except Exception as e:
        return f"è®¡ç®—é”™è¯¯: {e}"

# 2. åˆ›å»ºæ¨¡å‹
llm = ChatOpenAI(model="gpt-4o")

# 3. åˆ›å»ºå·¥å…·è°ƒç”¨æ™ºèƒ½ä½“
tools = [search, calculate]
agent = create_tool_calling_agent(
    llm,
    tools,
    system_prompt="ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„åŠ©æ‰‹ï¼Œå¯ä»¥ä½¿ç”¨å·¥å…·å›ç­”é—®é¢˜ã€‚"
)

# 4. è¿è¡Œæ™ºèƒ½ä½“
response = agent.invoke({
    "messages": [
        {"role": "user", "content": "æœç´¢ Python çš„æœ€æ–°ç‰ˆæœ¬å¹¶è®¡ç®— 3.11 * 2"}
    ]
})

print(response["messages"][-1].content)</code></pre>
                </div>

                <div class="note" data-label="æ³¨æ„">
                    <code>create_tool_calling_agent</code> æ˜¯ LangChain 1.0 æ¨èçš„æ–¹å¼ï¼Œå®ƒè‡ªåŠ¨ä¸ºæ”¯æŒå·¥å…·è°ƒç”¨çš„æ¨¡å‹ï¼ˆå¦‚ GPT-4ã€Claude 3ï¼‰å¯ç”¨åŸç”Ÿå·¥å…·è°ƒç”¨åŠŸèƒ½ã€‚
                </div>

                <h2>æ™ºèƒ½ä½“ç±»å‹</h2>

                <table class="comparison-table">
                    <tr>
                        <th>ç±»å‹</th>
                        <th>ç‰¹ç‚¹</th>
                        <th>é€‚ç”¨åœºæ™¯</th>
                    </tr>
                    <tr>
                        <td><code>create_tool_calling_agent</code></td>
                        <td>åŸç”Ÿå·¥å…·è°ƒç”¨</td>
                        <td>GPT-4ã€Claude 3 ç­‰ç°ä»£æ¨¡å‹</td>
                    </tr>
                    <tr>
                        <td><code>create_react_agent</code></td>
                        <td>ReAct æ¡†æ¶</td>
                        <td>éœ€è¦æ¨ç†æ­¥éª¤çš„åœºæ™¯</td>
                    </tr>
                    <tr>
                        <td><code>create_self_critique_agent</code></td>
                        <td>è‡ªæˆ‘æ‰¹è¯„</td>
                        <td>éœ€è¦ä¼˜åŒ–è¾“å‡ºçš„åœºæ™¯</td>
                    </tr>
                    <tr>
                        <td>è‡ªå®šä¹‰ Agent</td>
                        <td>å®Œå…¨è‡ªå®šä¹‰</td>
                        <td>ç‰¹æ®Šéœ€æ±‚åœºæ™¯</td>
                    </tr>
                </table>

                <h2>ReAct Agent</h2>
                <p>ReAct (Reasoning + Acting) æ˜¯ç»å…¸çš„æ™ºèƒ½ä½“æ¡†æ¶ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain.agents import create_react_agent
from langchain import hub
from langchain_openai import ChatOpenAI
from langchain_core.tools import tool

# è·å– ReAct æç¤ºæ¨¡æ¿
prompt = hub.pull("hwchase17/react")

# å®šä¹‰å·¥å…·
@tool
def get_word_length(word: str) -> int:
    """è·å–å•è¯é•¿åº¦"""
    return len(word)

@tool
def double_number(n: int) -> int:
    """å°†æ•°å­—ç¿»å€"""
    return n * 2

# åˆ›å»º ReAct æ™ºèƒ½ä½“
llm = ChatOpenAI(model="gpt-4o", temperature=0)
tools = [get_word_length, double_number]

agent = create_react_agent(
    llm,
    tools,
    prompt=prompt
)

# è¿è¡Œ
from langchain.agents import AgentExecutor
agent_executor = AgentExecutor(
    agent=agent,
    tools=tools,
    verbose=True  # æ‰“å°æ€è€ƒè¿‡ç¨‹
)

result = agent_executor.invoke({
    "input": "å•è¯ 'hello' çš„é•¿åº¦æ˜¯å¤šå°‘ï¼Ÿç„¶åæŠŠç»“æœç¿»å€"
})</code></pre>
                </div>

                <h2>Agent æ‰§è¡Œæµç¨‹</h2>

                <pre class="mermaid">sequenceDiagram
    participant U as ç”¨æˆ·
    participant A as Agent
    participant LLM as LLM
    participant T as å·¥å…·

    U->>A: å‘é€ä»»åŠ¡
    A->>LLM: è¯·æ±‚ + å·¥å…·å®šä¹‰
    LLM->>A: éœ€è¦è°ƒç”¨å·¥å…·
    A->>T: è°ƒç”¨å·¥å…·
    T->>A: è¿”å›ç»“æœ
    A->>LLM: ç»“æœ + ç»§ç»­è¯·æ±‚
    LLM->>A: éœ€è¦æ›´å¤šå·¥å…·
    A->>T: è°ƒç”¨å·¥å…·
    T->>A: è¿”å›ç»“æœ
    A->>LLM: æ‰€æœ‰ç»“æœ
    LLM->>A: ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ
    A->>U: è¿”å›å“åº”</code></pre>

                <h2>ç»“æ„åŒ–å·¥å…·è¾“å‡º</h2>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain_core.tools import tool
from typing import Literal
from pydantic import BaseModel, Field

# å®šä¹‰è¾“å‡ºç»“æ„
class WeatherResponse(BaseModel):
    """å¤©æ°”å“åº”"""
    location: str = Field(..., description="ä½ç½®")
    temperature: float = Field(..., description="æ¸©åº¦")
    condition: str = Field(..., description="å¤©æ°”çŠ¶å†µ")

    class Config:
        schema_extra = {
            "example": {
                "location": "åŒ—äº¬",
                "temperature": 25.5,
                "condition": "æ™´å¤©"
            }
        }

# åˆ›å»ºç»“æ„åŒ–è¾“å‡ºå·¥å…·
@tool
def get_weather(location: str) -> WeatherResponse:
    """è·å–æŒ‡å®šä½ç½®çš„å¤©æ°”ä¿¡æ¯"""
    # æ¨¡æ‹Ÿ API è°ƒç”¨
    import random
    return WeatherResponse(
        location=location,
        temperature=random.uniform(15, 35),
        condition=random.choice(["æ™´å¤©", "å¤šäº‘", "é›¨å¤©"])
    )

# ä½¿ç”¨
result = get_weather.invoke("ä¸Šæµ·")
print(result)
# WeatherResponse(location='ä¸Šæµ·', temperature=23.4, condition='å¤šäº‘')</code></pre>
                </div>

                <h2>å¤šå·¥å…·åä½œ</h2>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain import ChatOpenAI
from langchain.agents import create_tool_calling_agent
from langchain_core.tools import tool
import requests
import wikipedia

# å·¥å…· 1: è·å–å½“å‰æ—¶é—´
@tool
def get_current_time() -> str:
    """è·å–å½“å‰æ—¶é—´"""
    from datetime import datetime
    return datetime.now().strftime("%Y-%m-%d %H:%M:%S")

# å·¥å…· 2: æœç´¢ Wikipedia
@tool
def search_wikipedia(query: str) -> str:
    """åœ¨ Wikipedia ä¸Šæœç´¢"""
    try:
        summary = wikipedia.summary(query, sentences=2)
        return summary
    except:
        return f"æœªæ‰¾åˆ°å…³äº '{query}' çš„ Wikipedia æ¡ç›®"

# å·¥å…· 3: è·å–å¤©æ°”
@tool
def get_weather(location: str) -> str:
    """è·å–æŒ‡å®šä½ç½®çš„å¤©æ°”"""
    return f"{location}ä»Šå¤©å¤©æ°”æ™´æœ—ï¼Œæ¸©åº¦çº¦ 25Â°C"

# åˆ›å»ºæ™ºèƒ½ä½“
llm = ChatOpenAI(model="gpt-4o")
tools = [get_current_time, search_wikipedia, get_weather]

agent = create_tool_calling_agent(
    llm,
    tools,
    system_prompt="ä½ æ˜¯ä¸€ä¸ªå¤šåŠŸèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥ä½¿ç”¨å·¥å…·å›ç­”å„ç§é—®é¢˜ã€‚"
)

# æµ‹è¯•å¤šå·¥å…·åä½œ
response = agent.invoke({
    "messages": [
        {"role": "user", "content": "ç°åœ¨å‡ ç‚¹äº†ï¼Ÿå¸®æˆ‘æœç´¢ Python ç¼–ç¨‹è¯­è¨€çš„ç»´åŸºç™¾ç§‘ï¼Œé¡ºä¾¿æŸ¥ä¸€ä¸‹åŒ—äº¬çš„å¤©æ°”"}
    ]
})

print(response["messages"][-1].content)</code></pre>
                </div>

                <h2>è‡ªå®šä¹‰ Agent</h2>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain_core.agents import AgentExecutor, BaseSingleActionAgent
from langchain_core.prompts import PromptTemplate
from langchain_core.tools import tool
from langchain_openai import ChatOpenAI

# å®šä¹‰å·¥å…·
@tool
def multiply(a: int, b: int) -> int:
    """ä¹˜æ³•è¿ç®—"""
    return a * b

# è‡ªå®šä¹‰ Agent ç±»
class CalculatorAgent(BaseSingleActionAgent):
    """è®¡ç®—å™¨æ™ºèƒ½ä½“"""

    @property
    def input_keys(self):
        return ["input"]

    def plan(
        self,
        inputs,
        intermediate_steps,
        **kwargs
    ):
        """è§„åˆ’ä¸‹ä¸€æ­¥è¡ŒåŠ¨"""
        # åˆ†æè¾“å…¥å†³å®šæ˜¯å¦éœ€è¦è®¡ç®—
        if "ä¹˜ä»¥" in inputs["input"] or "x" in inputs["input"].lower():
            # æå–æ•°å­—
            import re
            numbers = re.findall(r'\d+', inputs["input"])
            if len(numbers) >= 2:
                return {
                    "action": multiply,
                    "action_input": {"a": int(numbers[0]), "b": int(numbers[1])}
                }
        return {"action": None, "action_input": inputs["input"]}

    async def aplan(
        self,
        inputs,
        intermediate_steps,
        **kwargs
    ):
        """å¼‚æ­¥è§„åˆ’"""
        return self.plan(inputs, intermediate_steps, **kwargs)

# åˆ›å»º Agent å®ä¾‹
agent = CalculatorAgent()

# åˆ›å»ºæ‰§è¡Œå™¨
agent_executor = AgentExecutor(
    agent=agent,
    tools=[multiply],
    verbose=True
)

# è¿è¡Œ
result = agent_executor.invoke({"input": "5 ä¹˜ä»¥ 3 ç­‰äºå¤šå°‘ï¼Ÿ"})
print(result["output"])</code></pre>
                </div>

                <h2>Agent è°ƒè¯•</h2>

                <div class="tip" data-label="è°ƒè¯•æŠ€å·§">
                    è®¾ç½® <code>verbose=True</code> å¯ä»¥æŸ¥çœ‹æ™ºèƒ½ä½“çš„å®Œæ•´æ€è€ƒè¿‡ç¨‹ï¼ŒåŒ…æ‹¬æ¨ç†ã€å·¥å…·é€‰æ‹©å’Œæ‰§è¡Œæ­¥éª¤ã€‚
                </div>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain.agents import AgentExecutor

# å¯ç”¨è¯¦ç»†è¾“å‡º
agent_executor = AgentExecutor(
    agent=agent,
    tools=tools,
    verbose=True,  # æ‰“å°æ¯ä¸€æ­¥
    return_intermediate_steps=True,  # è¿”å›ä¸­é—´æ­¥éª¤
    max_iterations=5,  # æœ€å¤§è¿­ä»£æ¬¡æ•°
    handle_parsing_errors=True,  # è‡ªåŠ¨å¤„ç†è§£æé”™è¯¯
    early_stopping_method="generate"  # æ—©æœŸåœæ­¢ç­–ç•¥
)

# æ‰§è¡Œå¹¶è·å–è¯¦ç»†æ­¥éª¤
result = agent_executor.invoke({"input": "å¤æ‚é—®é¢˜"})

# æŸ¥çœ‹ä¸­é—´æ­¥éª¤
for step in result["intermediate_steps"]:
    print(f"å·¥å…·è°ƒç”¨: {step[0].tool}")
    print(f"å·¥å…·è¾“å…¥: {step[0].tool_input}")
    print(f"å·¥å…·è¾“å‡º: {step[1]}")
    print("---")</code></pre>
                </div>

                <nav class="chapter-nav">
                    <a href="04-chains.html" class="prev">â† é“¾å¼è°ƒç”¨</a>
                    <a href="06-tools.html" class="next">å·¥å…·ç³»ç»Ÿ â†’</a>
                </nav>

                <div class="exercise-section">
                    <h3>âœï¸ ç»ƒä¹ é¢˜</h3>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">é€‰æ‹©é¢˜</span>
                            1. LangChain 1.0 æ¨èçš„åˆ›å»ºæ™ºèƒ½ä½“çš„æ–¹æ³•æ˜¯ï¼Ÿ
                        </div>
                        <div class="options">
                            <div class="option" onclick="this.classList.toggle('selected')">A. initialize_agent</div>
                            <div class="option correct-option onclick="this.classList.toggle('selected')">B. create_tool_calling_agent</div>
                            <div class="option" onclick="this.classList.toggle('selected')">C. AgentExecutor</div>
                            <div class="option" onclick="this.classList.toggle('selected')">D. create_react_agent</div>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-title">
                            <span class="question-type">ç¼–ç¨‹é¢˜</span>
                            2. åˆ›å»ºä¸€ä¸ªæ™ºèƒ½ä½“ï¼ŒåŒ…å«ä¸‰ä¸ªå·¥å…·ï¼šè·å–æ—¶é—´ã€è®¡ç®—åŠ æ³•ã€æœç´¢ç»´åŸºç™¾ç§‘
                        </div>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: var(--primary-color);">æŸ¥çœ‹å‚è€ƒç­”æ¡ˆ</summary>
                            <div class="code-block" style="margin-top: 10px;">
                                <div class="code-header">
                                    <span class="code-language">python</span>
                                    <button class="copy-btn">å¤åˆ¶</button>
                                </div>
                                <pre><code class="language-python">from langchain import ChatOpenAI
from langchain.agents import create_tool_calling_agent
from langchain_core.tools import tool
from datetime import datetime

@tool
def get_current_time() -> str:
    """è·å–å½“å‰æ—¥æœŸæ—¶é—´"""
    return datetime.now().strftime("%Y-%m-%d %H:%M:%S")

@tool
def add_numbers(a: int, b: int) -> int:
    """è®¡ç®—ä¸¤ä¸ªæ•°çš„å’Œ"""
    return a + b

@tool
def search_wikipedia(query: str) -> str:
    """åœ¨ Wikipedia ä¸Šæœç´¢ä¿¡æ¯"""
    try:
        import wikipedia
        return wikipedia.summary(query, sentences=2)
    except:
        return f"æœªæ‰¾åˆ° '{query}' çš„ç›¸å…³ä¿¡æ¯"

llm = ChatOpenAI(model="gpt-4o")
tools = [get_current_time, add_numbers, search_wikipedia]

agent = create_tool_calling_agent(
    llm,
    tools,
    system_prompt="ä½ æ˜¯ä¸€ä¸ªå¤šåŠŸèƒ½åŠ©æ‰‹ã€‚"
)

response = agent.invoke({
    "messages": [
        {"role": "user", "content": "ç°åœ¨å‡ ç‚¹ï¼Ÿè®¡ç®— 25 + 17ï¼Œæœç´¢äººå·¥æ™ºèƒ½"}
    ]
})

print(response["messages"][-1].content)</code></pre>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../assets/js/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</body>
</html>
