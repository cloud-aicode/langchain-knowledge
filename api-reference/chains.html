<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“¾å¼è°ƒç”¨ API - LangChain 1.0</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body class="chapter-api-chains">
    <button class="theme-toggle">ğŸŒ“</button>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>

    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1>LangChain 1.0</h1>
                <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-top: 5px;">API å‚è€ƒ</p>
            </div>
            <div class="sidebar-nav"></div>
        </nav>

        <main class="main-content">
            <div class="content">
                <h1>é“¾å¼è°ƒç”¨ API</h1>
                <p class="subtitle">LCEL æ“ä½œç¬¦ä¸é“¾ç»„åˆ</p>

                <div class="api-nav">
                    <a href="#overview" class="api-nav-link">æ¦‚è¿°</a>
                    <a href="#operators" class="api-nav-link">æ“ä½œç¬¦</a>
                    <a href="#functions" class="api-nav-link">ç»„åˆå‡½æ•°</a>
                    <a href="#examples" class="api-nav-link">ç¤ºä¾‹</a>
                </div>

                <h2 id="overview">æ¦‚è¿°</h2>
                <p>LangChain è¡¨è¾¾å¼è¯­è¨€ï¼ˆLCELï¼‰æä¾›äº†ä¸€å¥—å£°æ˜å¼çš„æ–¹æ³•æ¥ç»„åˆé“¾ã€‚æ‰€æœ‰ç»„ä»¶éƒ½å®ç°äº† <code>Runnable</code> æ¥å£ï¼Œå¯ä»¥ä½¿ç”¨ç»Ÿä¸€çš„æ“ä½œç¬¦è¿›è¡Œç»„åˆã€‚</p>

                <pre class="mermaid">graph LR
                    A[Runnable] --> B["| æ“ä½œç¬¦"]
                    B --> C[é“¾ç»„åˆ]

                    D[RunnableLambda] --> A
                    E[RunnableParallel] --> A
                    F[RunnableBranch] --> A
                    G[RunnablePassthrough] --> A

                    style A fill:#e1f5fe
                    style B fill:#c8e6c9</code></pre>

                <h2 id="operators">LCEL æ“ä½œç¬¦</h2>

                <div class="api-section">
                    <h3 class="api-title">| (ç®¡é“æ“ä½œç¬¦)</h3>
                    <p class="api-description">ä¸²è¡Œè¿æ¥ä¸¤ä¸ª Runnableã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">def __or__(
    self,
    other: Runnable[Any, Any],
) -> Runnable[InputType, OtherOutputType]:
    """
    ç®¡é“è¿æ¥

    expression: runnable1 | runnable2
    ç­‰ä»·äº: runnable1.pipe(runnable2)

    Args:
        other: ä¸‹ä¸€ä¸ª Runnable

    Returns:
        ç»„åˆåçš„ Runnable
    """</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser

prompt = ChatPromptTemplate.from_template("Tell me a joke about {topic}")
llm = ChatOpenAI(model="gpt-4o")
parser = StrOutputParser()

# ä½¿ç”¨ | æ“ä½œç¬¦ç»„åˆ
chain = prompt | llm | parser

# ç­‰ä»·äº:
# chain = prompt.pipe(llm).pipe(parser)

result = chain.invoke({"topic": "Python"})</code></pre>
                    </div>
                </div>

                <h2 id="functions">ç»„åˆå‡½æ•°</h2>

                <div class="api-section">
                    <h3 class="api-title">RunnableLambda</h3>
                    <p class="api-description">å°†å‡½æ•°è½¬æ¢ä¸º Runnableã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">class RunnableLambda(Serializable, Runnable[Input, Output]):
    """å‡½æ•°åŒ…è£…å™¨"""

    func: Callable[[Input], Output]
    """è¦åŒ…è£…çš„å‡½æ•°"""

    afunc: Optional[Callable[[Input], Awaitable[Output]]] = None
    """å¼‚æ­¥ç‰ˆæœ¬å‡½æ•°"""</code></pre>
                    </div>

                    <h4>æ„é€ æ–¹æ³•</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain_core.runnables import RunnableLambda

# åŒ…è£…æ™®é€šå‡½æ•°
def uppercase(text: str) -> str:
    return text.upper()

uppercase_runnable = RunnableLambda(uppercase)

# ä½¿ç”¨ lambda
runnable = RunnableLambda(lambda x: x["text"].upper())

# å¼‚æ­¥å‡½æ•°
import asyncio

async def auppercase(text: str) -> str:
    await asyncio.sleep(0.1)
    return text.upper()

async_runnable = RunnableLambda(func=uppercase, afunc=aucppercase)</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">RunnableParallel</h3>
                    <p class="api-description">å¹¶è¡Œæ‰§è¡Œå¤šä¸ª Runnableï¼Œåˆå¹¶ç»“æœã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">class RunnableParallel(
    Runnable[Input, Dict[str, Any]],
    Serializable,
):
    """å¹¶è¡Œæ‰§è¡Œ"""

    steps: Dict[str, Runnable[Any, Any]]
    """è¦å¹¶è¡Œæ‰§è¡Œçš„ Runnable æ˜ å°„"""

    # ä¹Ÿå¯ä»¥ä½¿ç”¨åˆ«å: RunnableParallel = RunnableParallel</code></pre>
                    </div>

                    <h4>ä½¿ç”¨æ–¹å¼</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain_core.runnables import RunnableParallel
from langchain_openai import ChatOpenAI

# æ–¹å¼1: ä½¿ç”¨å­—å…¸
chain = RunnableParallel({
    "joke": ChatOpenAI().pipe(lambda x: x.content),
    "poem": ChatOpenAI().pipe(lambda x: x.content),
})

result = chain.invoke({"input": "Tell me a joke and a poem"})

# æ–¹å¼2: ä½¿ç”¨ ** è§£åŒ…
joke_chain = ChatOpenAI() | (lambda x: x.content)
poem_chain = ChatOpenAI() | (lambda x: x.content)

chain = RunnableParallel(
    joke=joke_chain,
    poem=poem_chain
)

# æ–¹å¼3: åˆ†é…è¾“å…¥
parallel = RunnableParallel(
    input=lambda x: x["input"],
    output=lambda x: x["output"]
)</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">RunnableBranch</h3>
                    <p class="api-description">æ¡ä»¶åˆ†æ”¯ï¼Œæ ¹æ®è¾“å…¥è·¯ç”±åˆ°ä¸åŒçš„ Runnableã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">class RunnableBranch(
    Runnable[Input, Output],
    Serializable,
):
    """æ¡ä»¶åˆ†æ”¯"""

    branches: List[
        Tuple[
            Callable[[Input], bool],  # æ¡ä»¶å‡½æ•°
            Runnable[Input, Output]    # å¯¹åº”çš„ Runnable
        ]
    ]
    """(æ¡ä»¶, Runnable) åˆ—è¡¨"""</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain_core.runnables import RunnableBranch
from langchain_openai import ChatOpenAI

llm = ChatOpenAI(model="gpt-4o")

# å®šä¹‰ä¸åŒçš„å¤„ç†é“¾
joke_chain = ChatPromptTemplate.from_template("Tell me a joke about {topic}") | llm
poem_chain = ChatPromptTemplate.from_template("Write a poem about {topic}") | llm
fact_chain = ChatPromptTemplate.from_template("Tell me a fact about {topic}") | llm

# åˆ›å»ºåˆ†æ”¯
branch = RunnableBranch(
    (lambda x: x["style"] == "funny", joke_chain),
    (lambda x: x["style"] == "creative", poem_chain),
    fact_chain  # é»˜è®¤åˆ†æ”¯
)

result = branch.invoke({"style": "funny", "topic": "Python"})</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">RunnablePassthrough</h3>
                    <p class="api-description">åŸæ ·ä¼ é€’è¾“å…¥ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">class RunnablePassthrough(Runnable[Input, Input]):
    """åŸæ ·ä¼ é€’"""

    @staticmethod
    def assign(**kwargs: Union[Runnable[Any, Any], Any]) -> Runnable:
        """
        æ·»åŠ é¢å¤–å­—æ®µ

        Args:
            **kwargs: è¦æ·»åŠ çš„å­—æ®µæˆ– Runnable

        Returns:
            æ·»åŠ å­—æ®µåçš„ Runnable
        """</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain_core.runnables import RunnablePassthrough
from langchain_openai import ChatOpenAI

llm = ChatOpenAI()

# åŸæ ·ä¼ é€’
passthrough = RunnablePassthrough()
result = passthrough.invoke({"a": 1, "b": 2})
# {"a": 1, "b": 2}

# æ·»åŠ å­—æ®µ
chain = RunnablePassthrough.assign(
    output=lambda x: x["input"].upper()
)
result = chain.invoke({"input": "hello"})
# {"input": "hello", "output": "HELLO"}

# åœ¨é“¾ä¸­ä½¿ç”¨
from langchain_core.prompts import ChatPromptTemplate

prompt = ChatPromptTemplate.from_messages([
    ("user", "{input}")
])

chain = (
    {"input": RunnablePassthrough()} |
    prompt |
    llm |
    RunnablePassthrough.assign(
        original_input=lambda x: x["input"]
    )
)</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">RunnableMap</h3>
                    <p class="api-description">åˆ«åï¼šRunnableParallel</p>

                    <div class="api-signature">
                        <pre><code class="language-python">RunnableMap = RunnableParallel</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">RunnableGenerator</h3>
                    <p class="api-description">åŒ…è£…ç”Ÿæˆå™¨å‡½æ•°ä¸º Runnableã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">class RunnableGenerator(Runnable[Input, Output]):
    """ç”Ÿæˆå™¨åŒ…è£…å™¨"""

    transform: Callable[
        [Iterator[Input]],
        Iterator[Output]
    ]
    """è½¬æ¢å‡½æ•°ï¼ˆè¿­ä»£å™¨åˆ°è¿­ä»£å™¨ï¼‰"""

    atransform: Optional[Callable[
        [AsyncIterator[Input]],
        AsyncIterator[Output]
    ]] = None
    """å¼‚æ­¥ç‰ˆæœ¬"""</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">RunnableEach</h3>
                    <p class="api-description">å¯¹åˆ—è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ åº”ç”¨ Runnableã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">class RunnableEach(Runnable[List[Input], List[Output]]):
    """æ‰¹é‡å¤„ç†"""

    bound: Runnable[Input, Output]
    """è¦åº”ç”¨åˆ°æ¯ä¸ªå…ƒç´ çš„ Runnable"""</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain_core.runnables import RunnableEach
from langchain_openai import ChatOpenAI

llm = ChatOpenAI()

# æ‰¹é‡å¤„ç†
chain = RunnableEach(llm)

results = chain.invoke([
    "What is Python?",
    "What is JavaScript?",
    "What is Rust?"
])</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">RunnableItemPicker</h3>
                    <p class="api-description">ä»å­—å…¸ä¸­é€‰æ‹©ç‰¹å®šå­—æ®µã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">class RunnableItemPicker(Runnable[Dict[str, Any], Any]):
    """å­—æ®µé€‰æ‹©å™¨"""

    keys: Union[str, List[str]]
    """è¦é€‰æ‹©çš„é”®"""</code></pre>
                    </div>
                </div>

                <h2 id="examples">ä½¿ç”¨ç¤ºä¾‹</h2>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python">from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.runnables import (
    RunnableLambda,
    RunnableParallel,
    RunnablePassthrough,
    RunnableBranch
)
from langchain_core.output_parsers import StrOutputParser

llm = ChatOpenAI(model="gpt-4o")

# ========== ç¤ºä¾‹1: åŸºç¡€é“¾ ==========
prompt = ChatPromptTemplate.from_template("Tell me a {adjective} joke about {topic}")
chain = prompt | llm | StrOutputParser()
result = chain.invoke({"adjective": "funny", "topic": "Python"})

# ========== ç¤ºä¾‹2: å¹¶è¡Œæ‰§è¡Œ ==========
parallel = RunnableParallel({
    "joke": ChatPromptTemplate.from_template("Tell me a joke about {topic}") | llm | StrOutputParser(),
    "fact": ChatPromptTemplate.from_template("Tell me a fact about {topic}") | llm | StrOutputParser(),
})
result = parallel.invoke({"topic": "Python"})

# ========== ç¤ºä¾‹3: æ•°æ®æµè½¬æ¢ ==========
chain = (
    {"topic": RunnablePassthrough()} |
    ChatPromptTemplate.from_template("Tell me about {topic}") |
    llm |
    StrOutputParser()
)
result = chain.invoke("LangChain")

# ========== ç¤ºä¾‹4: æ¡ä»¶åˆ†æ”¯ ==========
def route_function(x):
    if "joke" in x["input"].lower():
        return "joke_chain"
    else:
        return "answer_chain"

joke_chain = ChatPromptTemplate.from_template("{input}") | llm | StrOutputParser()
answer_chain = ChatPromptTemplate.from_template("Answer: {input}") | llm | StrOutputParser()

branch = RunnableBranch(
    (lambda x: "joke" in x["input"].lower(), joke_chain),
    answer_chain
)

# ========== ç¤ºä¾‹5: è‡ªå®šä¹‰å¤„ç† ==========
def custom_process(x):
    # è‡ªå®šä¹‰å¤„ç†é€»è¾‘
    text = x["text"]
    return f"Processed: {text.upper()}"

chain = (
    RunnableLambda(lambda x: {"text": x}) |
    RunnableLambda(custom_process)
)

# ========== ç¤ºä¾‹6: å¤æ‚ç»„åˆ ==========
analysis_chain = (
    RunnableParallel({
        "topic": RunnablePassthrough(),
        "sentiment": (lambda x: ChatPromptTemplate.from_template(f"Analyze sentiment: {x}") | llm | StrOutputParser()),
    }) |
    RunnableLambda(lambda x: f"Topic: {x['topic']}, Sentiment: {x['sentiment']}")
)

# ========== ç¤ºä¾‹7: é”™è¯¯å¤„ç† ==========
from langchain_core.runnables import RunnableRetry

flaky_chain = ChatOpenAI() | StrOutputParser()
reliable_chain = RunnableRetry(
    bound=flaky_chain,
    max_attempts=3
)</code></pre>
                </div>

                <h2>ç›¸å…³ API</h2>
                <ul>
                    <li><a href="runnables.html">Runnables API</a> - Runnable æ¥å£è¯¦è§£</li>
                    <li><a href="prompts.html">Prompts API</a></li>
                    <li><a href="../04-chains.html">æ•™ç¨‹ï¼šé“¾å¼è°ƒç”¨</a></li>
                </ul>

                <div class="chapter-nav">
                    <a href="prompts.html">â† Prompts API</a>
                    <a href="runnables.html" class="next">Runnables API â†’</a>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="../assets/js/main.js"></script>
</body>
</html>
