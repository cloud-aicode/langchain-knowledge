<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­˜å‚¨åç«¯ API - LangChain 1.0</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body class="chapter-api-stores">
    <button class="theme-toggle">ğŸŒ“</button>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>

    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1><a href="../index.html" style="color: white; text-decoration: none;">LangChain 1.0</a></h1>
                <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-top: 5px;">API å‚è€ƒ</p>
            </div>
            <div class="sidebar-nav"></div>
        </nav>

        <main class="main-content">
            <div class="content">
                <h1>å­˜å‚¨åç«¯ API</h1>
                <p class="subtitle">BaseStore ä¸é”®å€¼å­˜å‚¨</p>

                <div class="api-nav">
                    <a href="#overview" class="api-nav-link">æ¦‚è¿°</a>
                    <a href="#base" class="api-nav-link">åŸºç±»</a>
                    <a href="#implementations" class="api-nav-link">å®ç°ç±»</a>
                    <a href="#examples" class="api-nav-link">ç¤ºä¾‹</a>
                </div>

                <h2 id="overview">æ¦‚è¿°</h2>
                <p>å­˜å‚¨åç«¯æä¾›é”®å€¼å­˜å‚¨åŠŸèƒ½ï¼Œç”¨äºå­˜å‚¨å†å²è®°å½•ã€æ–‡æ¡£ç¼“å­˜ç­‰æ•°æ®ã€‚</p>

                <pre class="mermaid">graph TD
                    A[BaseStore] --> B[InMemoryStore]
                    A --> C[RedisStore]
                    A --> D[LocalFileStore]
                    A --> E[UpstashStore]

    A --> F[ç‰¹å®šç”¨é€”]
    F --> G[BaseChatMessageHistory]
    F --> H[InMemoryChatMessageHistory]

    style A fill:#e1f5fe
    style B fill:#c8e6c9</code></pre>

                <h2 id="base">åŸºç±»</h2>

                <div class="api-section">
                    <h3 class="api-title">BaseStore</h3>
                    <p class="api-description">é”®å€¼å­˜å‚¨æŠ½è±¡åŸºç±»ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_core.stores import BaseStore

class BaseStore(Generic[K, V], ABC):
    """é”®å€¼å­˜å‚¨åŸºç±»

    Type Parameters:
        K: é”®ç±»å‹
        V: å€¼ç±»å‹
    """

    @abstractmethod
    async def aget(
        self,
        key: K,
    ) -> Optional[V]:
        """
        å¼‚æ­¥è·å–å€¼

        Args:
            key: é”®

        Returns:
            å€¼ï¼ˆå¦‚æœä¸å­˜åœ¨è¿”å› Noneï¼‰
        """

    @abstractmethod
    async def aset(
        self,
        key: K,
        value: V,
    ) -> None:
        """
        å¼‚æ­¥è®¾ç½®å€¼

        Args:
            key: é”®
            value: å€¼
        """

    @abstractmethod
    async def adelete(
        self,
        key: K,
    ) -> None:
        """
        å¼‚æ­¥åˆ é™¤å€¼

        Args:
            key: é”®
        """

    @abstractmethod
    async def alist(
        self,
        prefix: Optional[str] = None,
    ) -> AsyncIterator[K]:
        """
        å¼‚æ­¥åˆ—å‡ºé”®

        Args:
            prefix: é”®å‰ç¼€è¿‡æ»¤

        Yields:
            é”®
        """

    # åŒæ­¥æ–¹æ³•ï¼ˆé»˜è®¤è°ƒç”¨å¼‚æ­¥æ–¹æ³•ï¼‰
    def get(
        self,
        key: K,
    ) -> Optional[V]:
        """åŒæ­¥è·å–å€¼"""

    def set(
        self,
        key: K,
        value: V,
    ) -> None:
        """åŒæ­¥è®¾ç½®å€¼"""

    def delete(
        self,
        key: K,
    ) -> None:
        """åŒæ­¥åˆ é™¤å€¼"""

    def list(
        self,
        prefix: Optional[str] = None,
    ) -> Iterator[K]:
        """åŒæ­¥åˆ—å‡ºé”®"""

    async def amget(
        self,
        keys: Sequence[K],
    ) -> List[Optional[V]]:
        """
        æ‰¹é‡è·å–

        Args:
            keys: é”®åˆ—è¡¨

        Returns:
            å€¼åˆ—è¡¨
        """

    async def amset(
        self,
        key_value_pairs: Sequence[Tuple[K, V]],
    ) -> None:
        """
        æ‰¹é‡è®¾ç½®

        Args:
            key_value_pairs: (é”®, å€¼) åˆ—è¡¨
        """

    async def amdelete(
        self,
        keys: Sequence[K],
    ) -> None:
        """
        æ‰¹é‡åˆ é™¤

        Args:
            keys: é”®åˆ—è¡¨
        """</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">BaseChatMessageHistory</h3>
                    <p class="api-description">èŠå¤©å†å²å­˜å‚¨åŸºç±»ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_core.chat_history import BaseChatMessageHistory

class BaseChatMessageHistory(ABC):
    """èŠå¤©å†å²åŸºç±»"""

    @property
    @abstractmethod
    def messages(self) -> List[BaseMessage]:
        """è·å–æ¶ˆæ¯åˆ—è¡¨"""

    @abstractmethod
    async def aadd_messages(
        self,
        messages: Sequence[BaseMessage],
    ) -> None:
        """
        å¼‚æ­¥æ·»åŠ æ¶ˆæ¯

        Args:
            messages: æ¶ˆæ¯åˆ—è¡¨
        """

    @abstractmethod
    async def aclear(self) -> None:
        """å¼‚æ­¥æ¸…ç©ºå†å²"""

    # åŒæ­¥æ–¹æ³•
    def add_messages(
        self,
        messages: Sequence[BaseMessage],
    ) -> None:
        """æ·»åŠ æ¶ˆæ¯"""

    def clear(self) -> None:
        """æ¸…ç©ºå†å²"""</code></pre>
                    </div>
                </div>

                <h2 id="implementations">å®ç°ç±»</h2>

                <div class="api-section">
                    <h3 class="api-title">InMemoryStore</h3>
                    <p class="api-description">å†…å­˜é”®å€¼å­˜å‚¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_core.stores import InMemoryStore

class InMemoryStore(BaseStore[str, Any]):
    """å†…å­˜é”®å€¼å­˜å‚¨"""

    def __init__(self) -> None:
        """åˆå§‹åŒ–ï¼ˆä½¿ç”¨å­—å…¸å­˜å‚¨ï¼‰"""</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain_core.stores import InMemoryStore

store = InMemoryStore()

# è®¾ç½®å€¼
await store.aset("key1", "value1")
store.set("key2", "value2")

# è·å–å€¼
value = await store.aget("key1")
value = store.get("key2")

# æ‰¹é‡æ“ä½œ
await store.amset([
    ("key3", "value3"),
    ("key4", "value4")
])

values = await store.amget(["key1", "key2"])

# åˆ—å‡ºé”®
async for key in store.alist():
    print(key)

# åˆ é™¤
await store.adelete("key1")
store.delete("key2")</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">InMemoryChatMessageHistory</h3>
                    <p class="api-description">å†…å­˜èŠå¤©å†å²ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_core.chat_history import InMemoryChatMessageHistory

class InMemoryChatMessageHistory(BaseChatMessageHistory):
    """å†…å­˜èŠå¤©å†å²"""

    def __init__(self) -> None:
        """åˆå§‹åŒ–"""</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain_core.chat_history import InMemoryChatMessageHistory
from langchain_core.messages import HumanMessage, AIMessage

history = InMemoryChatMessageHistory()

# æ·»åŠ æ¶ˆæ¯
history.add_messages([
    HumanMessage(content="ä½ å¥½"),
    AIMessage(content="ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„ï¼Ÿ")
])

# æŸ¥çœ‹æ¶ˆæ¯
for msg in history.messages:
    print(f"{msg.type}: {msg.content}")

# æ¸…ç©ºå†å²
history.clear()</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">RedisStore</h3>
                    <p class="api-description">Redis é”®å€¼å­˜å‚¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_community.stores import RedisStore

class RedisStore(BaseStore[str, str]):
    """Redis é”®å€¼å­˜å‚¨"""

    def __init__(
        self,
        redis_client: Optional[Redis] = None,
        client_kwargs: Optional[dict] = None,
        prefix: str = "store:",
        ttl: Optional[int] = None,
    ):
        """
        åˆå§‹åŒ– Redis å­˜å‚¨

        Args:
            redis_client: è‡ªå®šä¹‰ Redis å®¢æˆ·ç«¯
            client_kwargs: å®¢æˆ·ç«¯å‚æ•°
                - host: ä¸»æœº
                - port: ç«¯å£
                - db: æ•°æ®åº“
                - password: å¯†ç 
            prefix: é”®å‰ç¼€
            ttl: è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
        """</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain_community.stores import RedisStore

# æ–¹å¼1: ä½¿ç”¨å®¢æˆ·ç«¯å‚æ•°
store = RedisStore(
    client_kwargs={
        "host": "localhost",
        "port": 6379,
        "db": 0
    },
    prefix="myapp:",
    ttl=3600  # 1å°æ—¶è¿‡æœŸ
)

# æ–¹å¼2: ä½¿ç”¨è‡ªå®šä¹‰å®¢æˆ·ç«¯
import redis

client = redis.Redis(host="localhost", port=6379, db=0)
store = RedisStore(redis_client=client)

# ä½¿ç”¨
await store.aset("user:123", "æ•°æ®")
value = await store.aget("user:123")</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">LocalFileStore</h3>
                    <p class="api-description">æœ¬åœ°æ–‡ä»¶å­˜å‚¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_stores import LocalFileStore

class LocalFileStore(BaseStore[str, str]):
    """æœ¬åœ°æ–‡ä»¶å­˜å‚¨"""

    def __init__(
        self,
        root_path: str,
    ):
        """
        åˆå§‹åŒ–

        Args:
            root_path: æ ¹ç›®å½•è·¯å¾„
        """</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain_stores import LocalFileStore

store = LocalFileStore("./data/store")

# è®¾ç½®å€¼ï¼ˆè‡ªåŠ¨åºåˆ—åŒ–ï¼‰
await store.aset("key1", "value1")

# è·å–å€¼ï¼ˆè‡ªåŠ¨ååºåˆ—åŒ–ï¼‰
value = await store.aget("key1")

# åˆ—å‡ºé”®
async for key in store.alist():
    print(key)</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">UpstashStore</h3>
                    <p class="api-description">Upstash Redis å…¼å®¹å­˜å‚¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_community.stores import UpstashStore

class UpstashStore(BaseStore[str, Any]):
    """Upstash å­˜å‚¨"""

    def __init__(
        self,
        client: Any = None,
        UpstashClient: Any = None,
        upstash_client: Any = None,
    ):
        """
        åˆå§‹åŒ–

        Args:
            client: Upstash å®¢æˆ·ç«¯
        """</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain_community.stores import UpstashStore
from upstash import Redis

# åˆ›å»ºå®¢æˆ·ç«¯
client = Redis(url="your-upstash-url", token="your-token")
store = UpstashStore(client=client)

# ä½¿ç”¨
await store.aset("key", "value")
value = await store.aget("key")</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">ChatMessageHistory å®ç°</h3>

                    <h4>RedisChatMessageHistory</h4>
                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_community.chat_message_histories import RedisChatMessageHistory

history = RedisChatMessageHistory(
    session_id="user_123",
    url="redis://localhost:6379/0",
    key_prefix="chat_history:"
)

history.add_message(HumanMessage(content="ä½ å¥½"))</code></pre>
                    </div>

                    <h4>PostgresChatMessageHistory</h4>
                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_community.chat_message_histories import PostgresChatMessageHistory

history = PostgresChatMessageHistory(
    connection_string="postgresql://user:pass@localhost/db",
    session_id="user_123",
    table_name="chat_history"
)</code></pre>
                    </div>

                    <h4>MongoDBChatMessageHistory</h4>
                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_community.chat_message_histories import MongoDBChatMessageHistory

history = MongoDBChatMessageHistory(
    connection_string="mongodb://localhost:27017",
    session_id="user_123",
    database_name="chat_db",
    collection_name="histories"
)</code></pre>
                    </div>

                    <h4>DynamoDBChatMessageHistory</h4>
                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_community.chat_message_histories import DynamoDBChatMessageHistory

history = DynamoDBChatMessageHistory(
    table_name="ChatHistory",
    session_id="user_123",
    endpoint_url="http://localhost:8000"
)</code></pre>
                    </div>
                </div>

                <h2 id="examples">ä½¿ç”¨ç¤ºä¾‹</h2>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python"># ========== ç¤ºä¾‹1: InMemoryStore åŸºç¡€ä½¿ç”¨ ==========
from langchain_core.stores import InMemoryStore

store = InMemoryStore()

# è®¾ç½®å’Œè·å–
await store.aset("user:123", {"name": "Alice", "age": 30})
user_data = await store.aget("user:123")

# ========== ç¤ºä¾‹2: æ‰¹é‡æ“ä½œ ==========
# æ‰¹é‡è®¾ç½®
await store.amset([
    ("key1", "value1"),
    ("key2", "value2"),
    ("key3", "value3")
])

# æ‰¹é‡è·å–
values = await store.amget(["key1", "key2", "key3"])

# æ‰¹é‡åˆ é™¤
await store.amdelete(["key1", "key2"])

# ========== ç¤ºä¾‹3: å¸¦å‰ç¼€åˆ—å‡º ==========
async for key in store.alist(prefix="user:"):
    print(key)

# ========== ç¤ºä¾‹4: èŠå¤©å†å²ç®¡ç† ==========
from langchain_core.chat_history import InMemoryChatMessageHistory
from langchain_core.messages import HumanMessage, AIMessage

history = InMemoryChatMessageHistory()

# æ·»åŠ å¯¹è¯
history.add_messages([
    HumanMessage(content="ä»€ä¹ˆæ˜¯ Pythonï¼Ÿ"),
    AIMessage(content="Python æ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€"),
    HumanMessage(content="å®ƒæœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ"),
    AIMessage(content="Python ç®€æ´æ˜“å­¦ã€åŠŸèƒ½å¼ºå¤§")
])

# æŸ¥çœ‹å†å²
for msg in history.messages:
    print(f"{msg.type}: {msg.content}")

# æ¸…ç©º
history.clear()

# ========== ç¤ºä¾‹5: æŒä¹…åŒ–èŠå¤©å†å²åˆ° Redis ==========
from langchain_community.chat_message_histories import RedisChatMessageHistory

# ä¸ºæ¯ä¸ªä¼šè¯åˆ›å»ºå†å²
def get_history(session_id: str):
    return RedisChatMessageHistory(
        session_id=session_id,
        url="redis://localhost:6379/0"
    )

history = get_history("user_123")
history.add_message(HumanMessage(content="ä½ å¥½"))

# ========== ç¤ºä¾‹6: è‡ªå®šä¹‰ Store ==========
from langchain_core.stores import BaseStore

class CustomStore(BaseStore[str, str]):
    def __init__(self):
        self._data = {}

    async def aget(self, key: str):
        return self._data.get(key)

    async def aset(self, key: str, value: str):
        self._data[key] = value

    async def adelete(self, key: str):
        self._data.pop(key, None)

    async def alist(self, prefix=None):
        if prefix:
            return (k for k in self._data if k.startswith(prefix))
        return iter(self._data)

# ========== ç¤ºä¾‹7: ä¸ RunnableWithMessageHistory é›†æˆ ==========
from langchain_core.runnables.history import RunnableWithMessageHistory

chain = prompt | llm

wrapped_chain = RunnableWithMessageHistory(
    runnable=chain,
    get_session_history=lambda session_id: get_history(session_id),
    input_messages_key="input",
    history_messages_key="history"
)

result = await wrapped_chain.ainvoke(
    {"input": "æˆ‘åˆšæ‰é—®äº†ä»€ä¹ˆï¼Ÿ"},
    config={"configurable": {"session_id": "user_123"}}
)</code></pre>
                </div>

                <h2>ç›¸å…³ API</h2>
                <ul>
                    <li><a href="memory.html">Memory API</a></li>
                    <li><a href="checkpointers.html">Checkpointers API</a></li>
                    <li><a href="../10-memory.html">æ•™ç¨‹ï¼šè®°å¿†ç®¡ç†</a></li>
                </ul>

                <div class="chapter-nav">
                    <a href="retrievers.html">â† Retrievers API</a>
                    <a href="memory.html" class="next">Memory API â†’</a>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="../assets/js/main.js"></script>
</body>
</html>
