<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿½è¸ªå™¨ API - LangChain 1.0</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body class="chapter-api-tracers">
    <button class="theme-toggle">ğŸŒ“</button>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>

    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1><a href="../index.html" style="color: white; text-decoration: none;">LangChain 1.0</a></h1>
            <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-top: 5px;">API å‚è€ƒ</p>
            </div>
            <div class="sidebar-nav"></div>
        </nav>

        <main class="main-content">
            <div class="content">
                <h1>è¿½è¸ªå™¨ API</h1>
                <p class="subtitle">LangSmith é“¾è·¯è¿½è¸ªä¸è°ƒè¯•</p>

                <div class="api-nav">
                    <a href="#overview" class="api-nav-link">æ¦‚è¿°</a>
                    <a href="#setup" class="api-nav-link">é…ç½®</a>
                    <a href="#runnables" class="api-nav-link">Runnable è¿½è¸ª</a>
                    <a href="#examples" class="api-nav-link">ç¤ºä¾‹</a>
                </div>

                <h2 id="overview">æ¦‚è¿°</h2>
                <p>LangSmith è¿½è¸ªç³»ç»Ÿè®©ä½ å®Œæ•´è®°å½• LangChain åº”ç”¨çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæ”¯æŒè°ƒè¯•ã€æ€§èƒ½åˆ†æå’Œè´¨é‡è¯„ä¼°ã€‚</p>

                <pre class="mermaid">graph LR
    A[LangChain åº”ç”¨] --> B[è®¾ç½®ç¯å¢ƒå˜é‡]
    B --> C[è‡ªåŠ¨è¿½è¸ª]
    C --> D[LangSmith å¹³å°]

    D --> E[æŸ¥çœ‹æ‰§è¡Œé“¾è·¯]
    D --> F[æ€§èƒ½åˆ†æ]
    D --> G[å¯¹æ¯”ç‰ˆæœ¬]

    E --> H[è°ƒè¯•]
    F --> I[ä¼˜åŒ–]
    G --> J[A/B æµ‹è¯•]

    style B fill:#e1f5fe
    style D fill:#c8e6c9</code></pre>

                <h2 id="setup">é…ç½®</h2>

                <div class="api-section">
                    <h3 class="api-title">ç¯å¢ƒå˜é‡é…ç½®</h3>
                    <p class="api-description">è®¾ç½®ç¯å¢ƒå˜é‡å¯ç”¨è‡ªåŠ¨è¿½è¸ªã€‚</p>

                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">bash</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-bash"># è®¾ç½®ç¯å¢ƒå˜é‡
export LANGCHAIN_TRACING_V2=true
export LANGCHAIN_API_KEY="lsv2_your-api-key-here"
export LANGCHAIN_PROJECT="my-awesome-project"

# æˆ–åœ¨ä»£ç ä¸­è®¾ç½®
import os
os.environ["LANGCHAIN_TRACING_V2"] = "true"
os.environ["LANGCHAIN_API_KEY"] = "lsv2_your-key"
os.environ["LANGCHAIN_PROJECT"] = "my-project"</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">å¯é€‰ç¯å¢ƒå˜é‡</h3>

                    <table class="api-table">
                        <tr>
                            <th>å˜é‡</th>
                            <th>è¯´æ˜</th>
                            <th>é»˜è®¤å€¼</th>
                        </tr>
                        <tr>
                            <td>LANGCHAIN_TRACING_V2</td>
                            <td>æ˜¯å¦å¯ç”¨è¿½è¸ª</td>
                            <td>false</td>
                        </tr>
                        <tr>
                            <td>LANGCHAIN_API_KEY</td>
                            <td>LangSmith API å¯†é’¥</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>LANGCHAIN_ENDPOINT</td>
                            <td>API ç«¯ç‚¹ URL</td>
                            <td>https://api.smith.langchain.com</td>
                        </tr>
                        <tr>
                            <td>LANGCHAIN_PROJECT</td>
                            <td>é¡¹ç›®åç§°</td>
                            <td>default</td>
                        </tr>
                        <tr>
                            <td>LANGCHAIN_SESSION</td>
                            <td>ä¼šè¯åç§°</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>LANGCHAIN_HIDE_INPUTS</td>
                            <td>æ˜¯å¦éšè—è¾“å…¥ï¼ˆéšç§ä¿æŠ¤ï¼‰</td>
                            <td>false</td>
                        </tr>
                    </table>
                </div>

                <h2 id="runnables">Runnable è¿½è¸ª</h2>

                <div class="api-section">
                    <h3 class="api-title">é…ç½®å‚æ•°</h3>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_core.runnables import RunnableConfig

# è¿½è¸ªé…ç½®
config = RunnableConfig(
    callbacks=[callback_handler],  # å›è°ƒå¤„ç†å™¨
    tags=["production", "api"],      # æ ‡ç­¾
    metadata={                        # å…ƒæ•°æ®
        "user_id": "user_123",
        "version": "1.0"
    },
    run_name="my_chain_run"            # è¿è¡Œåç§°
)

result = chain.invoke(input_data, config=config)</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">ä½¿ç”¨å›è°ƒè¿½è¸ª</h3>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_core.callbacks import BaseCallbackHandler

class TracingCallback(BaseCallbackHandler):
    """è‡ªå®šä¹‰è¿½è¸ªå›è°ƒ"""

    def __init__(self, project_name: str):
        self.project_name = project_name

    def on_chain_start(self, serialized, inputs, **kwargs):
        print(f"[{self.project_name}] Chain å¼€å§‹: {inputs}")

    def on_chain_end(self, outputs, **kwargs):
        print(f"[{self.project_name}] Chain ç»“æŸ: {outputs}")

    def on_llm_start(self, serialized, prompts, **kwargs):
        print(f"[{self.project_name}] LLM å¼€å§‹")

    def on_llm_end(self, response, **kwargs):
        print(f"[{self.project_name}] LLM ç»“æŸ")

# ä½¿ç”¨
handler = TracingCallback("my_project")
result = chain.invoke(input, config={"callbacks": [handler]})</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">LangSmith é›†æˆ</h3>

                    <div class="api-signature">
                        <pre><code class="language-python">from langsmith import Client

# åˆå§‹åŒ–å®¢æˆ·ç«¯
client = Client(
    api_key="lsv2_your-key",
    api_url="https://api.smith.langchain.com"  # å¯é€‰
)

# åˆ›å»ºè¿è¡Œ
run = client.create_run(
    project_name="my-project",
    name="test_run",
    inputs={"query": "test"}
)

# è®°å½•äº‹ä»¶
run.create_event(
    event_type="llm",
    inputs={"prompt": "hello"},
    outputs={"response": "hi there"}
)

# ç»“æŸè¿è¡Œ
run.end(outputs={"result": "success"})

# ========== æŸ¥è¯¢è¿è¡Œ ==========
# åˆ—å‡ºè¿è¡Œ
runs = client.list_runs(
    project_name="my-project",
    execution_order="DESC",  # æ’åº
    limit=10
)

# è·å–ç‰¹å®šè¿è¡Œ
run = client.read_run(run_id="run_id_here")

# ========== å¯¹æ¯”è¿è¡Œ ==========
from langsmith import evaluators

result = evaluators.create_comparison(
    runs=[run_id_1, run_id_2]
)</code></pre>
                    </div>
                </div>

                <h2 id="examples">ä½¿ç”¨ç¤ºä¾‹</h2>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python"># ========== ç¤ºä¾‹1: åŸºç¡€è‡ªåŠ¨è¿½è¸ª ==========
import os
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate

# å¯ç”¨è¿½è¸ª
os.environ["LANGCHAIN_TRACING_V2"] = "true"
os.environ["LANGCHAIN_API_KEY"] = "lsv2_your-key"
os.environ["LANGCHAIN_PROJECT"] = "demo"

# æ­£å¸¸ä½¿ç”¨ - è‡ªåŠ¨è¿½è¸ª
prompt = ChatPromptTemplate.from_template("è®²ä¸€ä¸ªå…³äº{topic}çš„æ•…äº‹")
llm = ChatOpenAI(model="gpt-4o")
chain = prompt | llm

result = chain.invoke({"topic": "Python"})
# è‡ªåŠ¨è®°å½•åˆ° LangSmith

# ========== ç¤ºä¾‹2: æ·»åŠ è‡ªå®šä¹‰è¿½è¸ª ==========
from langchain_core.callbacks import BaseCallbackHandler

class CustomTracer(BaseCallbackHandler):
    def on_llm_start(self, serialized, prompts, **kwargs):
        print(f"LLM è¾“å…¥: {prompts[0][:50]}...")

    def on_llm_end(self, response, **kwargs):
        if hasattr(response, "llm_output"):
            usage = response.llm_output.get("token_usage", {})
            print(f"Token ä½¿ç”¨: {usage}")

result = chain.invoke(
    {"topic": "Python"},
    config={"callbacks": [CustomTracer()]}
)

# ========== ç¤ºä¾‹3: å¤šæ ‡ç­¾å’Œå…ƒæ•°æ® ==========
result = chain.invoke(
    {"topic": "Python"},
    config={
        "tags": ["production", "v1.0"],
        "metadata": {
            "user_id": "user_123",
            "environment": "production",
            "model": "gpt-4o"
        },
        "run_name": "story_generation"
    }
)

# ========== ç¤ºä¾‹4: æŸ¥è¯¢è¿è¡Œå†å² ==========
from langsmith import Client

client = Client(api_key="lsv2_your-key")

# åˆ—å‡ºæœ€è¿‘è¿è¡Œ
runs = client.list_runs(
    project_name="demo",
    limit=10
)

for run in runs:
    print(f"Run: {run.name}, ID: {run.id}")

# ========== ç¤ºä¾‹5: å¯¹æ¯”ä¸¤ä¸ªè¿è¡Œ ==========
run_id_1 = "first_run_id"
run_id_2 = "second_run_id"

comparison = client.compare_runs(
    run_a=run_id_1,
    run_b=run_id_2
)

# ========== ç¤ºä¾‹6: è·å–æ€§èƒ½æ•°æ® ==========
run = client.read_run(run_id="some_id")

# è®¡ç®—è€—æ—¶
start_time = run.start_time
end_time = run.end_time
duration = (end_time - start_time).total_seconds()

# Token ç»Ÿè®¡
if run.outputs:
    llm_results = run.outputs.get("llm_output", {})
    tokens = llm_results.get("token_usage", {})
    print(f"è€—æ—¶: {duration}s, Tokens: {tokens}")

# ========== ç¤ºä¾‹7: æœ¬åœ°è¿½è¸ªï¼ˆä¸ä½¿ç”¨ LangSmithï¼‰==========
from langchain.callbacks import StdOutCallbackHandler

handler = StdOutCallbackHandler()
result = chain.invoke(
    {"topic": "Python"},
    config={"callbacks": [handler]}
)
# æ‰“å°åˆ°æ§åˆ¶å°</code></pre>
                </div>

                <h2>ç›¸å…³ API</h2>
                <ul>
                    <li><a href="callbacks.html">Callbacks API</a></li>
                    <li><a href="evaluators.html">Evaluators API</a></li>
                    <li><a href="../15-tracing.html">æ•™ç¨‹ï¼šé“¾è·¯è¿½è¸ª</a></li>
                </ul>

                <div class="chapter-nav">
                    <a href="callbacks.html">â† Callbacks API</a>
                    <a href="evaluators.html" class="next">Evaluators API â†’</a>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="../assets/js/main.js"></script>
</body>
</html>
