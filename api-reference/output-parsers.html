<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾“å‡ºè§£æå™¨ API - LangChain 1.0</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body class="chapter-api-output-parsers">
    <button class="theme-toggle">ğŸŒ“</button>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>

    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1>LangChain 1.0</h1>
                <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-top: 5px;">API å‚è€ƒ</p>
            </div>
            <div class="sidebar-nav"></div>
        </nav>

        <main class="main-content">
            <div class="content">
                <h1>è¾“å‡ºè§£æå™¨ API</h1>
                <p class="subtitle">BaseOutputParser ä¸ç»“æ„åŒ–è¾“å‡º</p>

                <div class="api-nav">
                    <a href="#overview" class="api-nav-link">æ¦‚è¿°</a>
                    <a href="#base" class="api-nav-link">åŸºç±»</a>
                    <a href="#types" class="api-nav-link">è§£æå™¨ç±»å‹</a>
                    <a href="#examples" class="api-nav-link">ç¤ºä¾‹</a>
                </div>

                <h2 id="overview">æ¦‚è¿°</h2>
                <p>è¾“å‡ºè§£æå™¨å°† LLM çš„åŸå§‹è¾“å‡ºè½¬æ¢ä¸ºç»“æ„åŒ–æ•°æ®ï¼ˆå¦‚ JSONã€å¯¹è±¡ã€åˆ—è¡¨ç­‰ï¼‰ã€‚</p>

                <pre class="mermaid">graph TD
                    A[BaseOutputParser] --> B[StrOutputParser]
                    A --> C[PydanticOutputParser]
                    A --> D[JsonOutputParser]
                    A --> E[CommaSeparatedListOutputParser]
    A --> F[StructuredOutputParser]
    A --> G[XMLOutputParser]

    style A fill:#e1f5fe
    style C fill:#c8e6c9</code></pre>

                <h2 id="base">åŸºç±»</h2>

                <div class="api-section">
                    <h3 class="api-title">BaseOutputParser</h3>
                    <p class="api-description">è¾“å‡ºè§£æå™¨æŠ½è±¡åŸºç±»ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_core.output_parsers import BaseOutputParser

class BaseOutputParser(Generic[T], ABC):
    """è¾“å‡ºè§£æå™¨åŸºç±»

    Type Parameters:
        T: è¾“å‡ºç±»å‹
    """

    @property
    @abstractmethod
    def _type(self) -> str:
        """è¿”å›è§£æå™¨ç±»å‹æ ‡è¯†"""

    @abstractmethod
    def parse(self, text: str) -> T:
        """
        è§£ææ–‡æœ¬

        Args:
            text: LLM è¾“å‡ºæ–‡æœ¬

        Returns:
            è§£æåçš„æ•°æ®

        Raises:
            OutputParserException: è§£æå¤±è´¥
        """

    def parse_result(
        self,
        result: Generation,
        *,
        partial: bool = False,
    ) -> T:
        """
        è§£æ Generation å¯¹è±¡

        Args:
            result: Generation å¯¹è±¡
            partial: æ˜¯å¦å…è®¸éƒ¨åˆ†è§£æ

        Returns:
            è§£æåçš„æ•°æ®
        """

    def get_format_instructions(self) -> str:
        """
        è·å–æ ¼å¼è¯´æ˜

        Returns:
            æ ¼å¼è¯´æ˜å­—ç¬¦ä¸²ï¼ˆç”¨äº Promptï¼‰
        """

    @property
    def OutputType(self) -> Type[T]:
        """è¿”å›è¾“å‡ºç±»å‹"""
        return self.__orig_bases__[0].__args__[0]

    def _fix_json(self, text: str) -> str:
        """
        ä¿®å¤ JSON æ ¼å¼

        Args:
            text: å¯èƒ½æœ‰é—®é¢˜çš„ JSON å­—ç¬¦ä¸²

        Returns:
            ä¿®å¤åçš„ JSON å­—ç¬¦ä¸²
        """</code></pre>
                    </div>
                </div>

                <h2 id="types">è§£æå™¨ç±»å‹</h2>

                <div class="api-section">
                    <h3 class="api-title">StrOutputParser</h3>
                    <p class="api-description">å­—ç¬¦ä¸²è¾“å‡ºè§£æå™¨ï¼ˆæœ€å¸¸ç”¨ï¼‰ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_core.output_parsers import StrOutputParser

class StrOutputParser(BaseOutputParser[str]):
    """å­—ç¬¦ä¸²è¾“å‡ºè§£æå™¨"""

    def parse(self, text: str) -> str:
        """
        è§£æä¸ºå­—ç¬¦ä¸²

        Args:
            text: LLM è¾“å‡ºï¼ˆå¯èƒ½æ˜¯ AIMessage æˆ–å­—ç¬¦ä¸²ï¼‰

        Returns:
            å­—ç¬¦ä¸²å†…å®¹
        """</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain_core.output_parsers import StrOutputParser
from langchain_openai import ChatOpenAI

llm = ChatOpenAI(model="gpt-4o")

# åœ¨é“¾ä¸­ä½¿ç”¨
chain = llm | StrOutputParser()

result = chain.invoke("è®²ä¸€ä¸ªç¬‘è¯")
print(result)  # çº¯å­—ç¬¦ä¸²</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">PydanticOutputParser</h3>
                    <p class="api-description">Pydantic æ¨¡å‹è¾“å‡ºè§£æå™¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_core.output_parsers import PydanticOutputParser

class PydanticOutputParser(BaseOutputParser[BaseModel]):
    """Pydantic è¾“å‡ºè§£æå™¨"""

    pydantic_object: Type[BaseModel]
    """ç›®æ ‡ Pydantic æ¨¡å‹"""

    def __init__(
        self,
        pydantic_object: Type[BaseModel],
    ):
        """
        åˆå§‹åŒ–

        Args:
            pydantic_object: ç›®æ ‡ Pydantic æ¨¡å‹ç±»
        """

    def get_format_instructions(self) -> str:
        """
        è·å–æ ¼å¼è¯´æ˜

        Returns:
            JSON Schema æ ¼å¼çš„è¯´æ˜
        """

    def parse(self, text: str) -> BaseModel:
        """
        è§£æä¸º Pydantic å¯¹è±¡

        Args:
            text: LLM è¾“å‡ºï¼ˆåº”è¯¥æ˜¯ JSONï¼‰

        Returns:
            Pydantic æ¨¡å‹å®ä¾‹
        """</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain_core.output_parsers import PydanticOutputParser
from langchain_openai import ChatOpenAI
from pydantic import BaseModel, Field

# å®šä¹‰è¾“å‡ºæ¨¡å‹
class Answer(BaseModel):
    summary: str = Field(description="ç­”æ¡ˆæ‘˜è¦")
    confidence: float = Field(description="ç½®ä¿¡åº¦ (0-1)")
    sources: list[str] = Field(description="ä¿¡æ¯æ¥æº")

# åˆ›å»ºè§£æå™¨
parser = PydanticOutputParser(pydantic_object=Answer)

# è·å–æ ¼å¼è¯´æ˜
format_instructions = parser.get_format_instructions()

# åœ¨æç¤ºä¸­ä½¿ç”¨
from langchain_core.prompts import ChatPromptTemplate

prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„åŠ©æ‰‹"),
    ("user", "{format_instructions}\n\né—®é¢˜: {query}")
])

chain = prompt | ChatOpenAI(model="gpt-4o") | parser

result = chain.invoke({
    "query": "ä»€ä¹ˆæ˜¯ Pythonï¼Ÿ",
    "format_instructions": format_instructions
})

print(result.summary)     # "Python æ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€"
print(result.confidence)  # 0.95
print(result.sources)     # ["å®˜æ–¹æ–‡æ¡£", "ç»´åŸºç™¾ç§‘"]</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">JsonOutputParser</h3>
                    <p class="api-description">JSON è¾“å‡ºè§£æå™¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_core.output_parsers import JsonOutputParser

class JsonOutputParser(BaseOutputParser[Union[Dict, List]]):
    """JSON è¾“å‡ºè§£æå™¨"""

    def __init__(
        self,
        pydantic_object: Optional[Type[BaseModel]] = None,
    ):
        """
        åˆå§‹åŒ–

        Args:
            pydantic_object: å¯é€‰çš„ Pydantic æ¨¡å‹ï¼ˆç”¨äºéªŒè¯ï¼‰
        """</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain_core.output_parsers import JsonOutputParser

# åŸºç¡€ä½¿ç”¨
parser = JsonOutputParser()

# è§£æ JSON å­—ç¬¦ä¸²
result = parser.parse('{"name": "Alice", "age": 30}')
# {"name": "Alice", "age": 30}

# è§£æ JSON æ•°ç»„
result = parser.parse('["apple", "banana", "orange"]')
# ["apple", "banana", "orange"]

# åœ¨é“¾ä¸­ä½¿ç”¨
from langchain_core.prompts import PromptTemplate
from langchain_openai import ChatOpenAI

prompt = PromptTemplate.from_template(
    "è¿”å› {topic} çš„ 3 ä¸ªç‰¹ç‚¹ï¼Œç”¨ JSON æ•°ç»„æ ¼å¼: {format_instructions}"
)

chain = prompt | ChatOpenAI(model="gpt-4o") | parser

result = chain.invoke({
    "topic": "Python",
    "format_instructions": parser.get_format_instructions()
})
# ["ç®€æ´æ˜“å­¦", "åŠŸèƒ½å¼ºå¤§", "åº”ç”¨å¹¿æ³›"]</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">CommaSeparatedListOutputParser</h3>
                    <p class="api-description">é€—å·åˆ†éš”åˆ—è¡¨è§£æå™¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_core.output_parsers import CommaSeparatedListOutputParser

class CommaSeparatedListOutputParser(BaseOutputParser[List[str]]):
    """é€—å·åˆ†éš”åˆ—è¡¨è§£æå™¨"""

    def parse(self, text: str) -> List[str]:
        """
        è§£æä¸ºåˆ—è¡¨

        Args:
            text: é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²

        Returns:
            å­—ç¬¦ä¸²åˆ—è¡¨
        """</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain_core.output_parsers import CommaSeparatedListOutputParser

parser = CommaSeparatedListOutputParser()

result = parser.parse("apple, banana, orange")
# ["apple", "banana", "orange"]

# åœ¨é“¾ä¸­ä½¿ç”¨
chain = llm | parser
result = chain.invoke("åˆ—å‡º3ç§æ°´æœï¼Œç”¨é€—å·åˆ†éš”")</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">StructuredOutputParser</h3>
                    <p class="api-description">ç»“æ„åŒ–è¾“å‡ºè§£æå™¨ï¼ˆæ—§ç‰ˆï¼‰ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_core.output_parsers import StructuredOutputParser

class StructuredOutputParser(BaseOutputParser[Dict[str, Any]]):
    """ç»“æ„åŒ–è¾“å‡ºè§£æå™¨ï¼ˆæ—§ç‰ˆï¼Œæ¨èä½¿ç”¨ PydanticOutputParserï¼‰"""

    response_schema: Dict[str, Any]
    """è¾“å‡ºæ¨¡å¼ï¼ˆå­—æ®µååˆ°æè¿°çš„æ˜ å°„ï¼‰"""</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">XMLOutputParser</h3>
                    <p class="api-description">XML è¾“å‡ºè§£æå™¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_core.output_parsers import XMLOutputParser

class XMLOutputParser(BaseOutputParser[Dict[str, Any]]):
    """XML è¾“å‡ºè§£æå™¨"""

    tags: List[str]
    """è¦æå–çš„æ ‡ç­¾åˆ—è¡¨"""

    def __init__(
        self,
        tags: List[str],
        *,
        strip_tags: bool = False,
    ):
        """
        åˆå§‹åŒ–

        Args:
            tags: è¦æå–çš„ XML æ ‡ç­¾
            strip_tags: æ˜¯å¦ç§»é™¤æ ‡ç­¾æœ¬èº«
        """</code></pre>
                    </div>
                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain_core.output_parsers import XMLOutputParser

parser = XMLOutputParser(tags=["name", "age", "city"])

xml_text = """
<person>
    <name>Alice</name>
    <age>30</age>
    <city>NYC</city>
</person>
"""

result = parser.parse(xml_text)
# {"name": "Alice", "age": "30", "city": "NYC"}</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">RetryOutputParser</h3>
                    <p class="api-description">å¸¦é‡è¯•çš„è¾“å‡ºè§£æå™¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_core.output_parsers import OutputFixingParser

class OutputFixingParser(BaseOutputParser[T]):
    """è¾“å‡ºä¿®å¤è§£æå™¨"""

    parser: BaseOutputParser[T]
    """åº•å±‚è§£æå™¨"""

    retry_llm: BaseLanguageModel
    """ç”¨äºä¿®å¤çš„ LLM"""

    def __init__(
        self,
        parser: BaseOutputParser[T],
        retry_llm: BaseLanguageModel,
    ):
        """
        åˆå§‹åŒ–

        Args:
            parser: å¯èƒ½å¤±è´¥çš„è§£æå™¨
            retry_llm: ç”¨äºä¿®å¤è¾“å‡ºçš„ LLM
        """</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain_core.output_parsers import OutputFixingParser
from langchain_openai import ChatOpenAI
from pydantic import BaseModel

class Output(BaseModel):
    answer: str

base_parser = PydanticOutputParser(pydantic_object=Output)
fixing_parser = OutputFixingParser.from_llm(
    parser=base_parser,
    llm=ChatOpenAI(model="gpt-4o")
)

# å³ä½¿ç¬¬ä¸€æ¬¡è¾“å‡ºæ ¼å¼é”™è¯¯ï¼Œä¹Ÿä¼šè‡ªåŠ¨ä¿®å¤
chain = ChatOpenAI(model="gpt-4o") | fixing_parser</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">Custom è£…é¥°å™¨</h3>
                    <p class="api-description">åˆ›å»ºè‡ªå®šä¹‰è§£æå™¨çš„è£…é¥°å™¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_core.output_parsers import @output_parser

@output_parser
def parse_uppercase(text: str) -> str:
    """å°†è¾“å‡ºè½¬ä¸ºå¤§å†™"""
    return text.upper()

# ä½¿ç”¨
chain = llm | parse_uppercase</code></pre>
                    </div>
                </div>

                <h2 id="examples">ä½¿ç”¨ç¤ºä¾‹</h2>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python"># ========== ç¤ºä¾‹1: åŸºç¡€å­—ç¬¦ä¸²è§£æ ==========
from langchain_core.output_parsers import StrOutputParser
from langchain_openai import ChatOpenAI

llm = ChatOpenAI(model="gpt-4o")
chain = llm | StrOutputParser()

result = chain.invoke("è®²ä¸€ä¸ªç¬‘è¯")

# ========== ç¤ºä¾‹2: Pydantic è§£æ ==========
from pydantic import BaseModel, Field
from langchain_core.output_parsers import PydanticOutputParser

class MovieReview(BaseModel):
    title: str = Field(description="ç”µå½±æ ‡é¢˜")
    rating: float = Field(description="è¯„åˆ† (0-10)")
    summary: str = Field(description="å‰§æƒ…ç®€ä»‹")

parser = PydanticOutputParser(pydantic_object=MovieReview)

prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€ä¸ªå½±è¯„äººã€‚{format_instructions}"),
    ("user", "è¯„ä»·ç”µå½±: {movie_title}")
])

chain = prompt | ChatOpenAI(model="gpt-4o") | parser

review = chain.invoke({
    "movie_title": "ç›—æ¢¦ç©ºé—´",
    "format_instructions": parser.get_format_instructions()
})

print(review.title)    # "ç›—æ¢¦ç©ºé—´"
print(review.rating)   # 9.5
print(review.summary)  # "ä¸€éƒ¨å…³äºæ¢¦å¢ƒçš„ç§‘å¹»æƒŠæ‚šç‰‡..."

# ========== ç¤ºä¾‹3: JSON è§£æ ==========
from langchain_core.output_parsers import JsonOutputParser

parser = JsonOutputParser()

prompt = PromptTemplate.from_template(
    "è¿”å› {query} çš„ 3 ä¸ªç›¸å…³ä¿¡æ¯ï¼Œç”¨ JSON æ ¼å¼: {format_instructions}"
)

chain = prompt | ChatOpenAI(model="gpt-4o") | parser

result = chain.invoke({
    "query": "Python ç¼–ç¨‹",
    "format_instructions": parser.get_format_instructions()
})
# ["Python æ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€", "ç”± Guido van Rossum åˆ›å»º", "å¹¿æ³›åº”ç”¨äºæ•°æ®ç§‘å­¦"]

# ========== ç¤ºä¾‹4: è‡ªå®šä¹‰è§£æå™¨ ==========
from langchain_core.output_parsers import BaseOutputParser

class DateOutputParser(BaseOutputParser[str]):
    """æ—¥æœŸè§£æå™¨"""

    def parse(self, text: str) -> str:
        # æå–æ—¥æœŸ
        import re
        date_pattern = r'\d{4}-\d{2}-\d{2}'
        match = re.search(date_pattern, text)
        if match:
            return match.group(0)
        raise ValueError(f"æœªæ‰¾åˆ°æ—¥æœŸ: {text}")

    def get_format_instructions(self) -> str:
        return "è¯·ä½¿ç”¨ YYYY-MM-DD æ ¼å¼è¿”å›æ—¥æœŸ"

chain = llm | DateOutputParser()
date = chain.invoke("ä»Šå¤©æ˜¯å‡ å·ï¼Ÿ")

# ========== ç¤ºä¾‹5: é”™è¯¯å¤„ç† ==========
from langchain_core.exceptions import OutputParserException

try:
    result = parser.parse("invalid json")
except OutputParserException as e:
    print(f"è§£æå¤±è´¥: {e}")

# ä½¿ç”¨å¸¦é‡è¯•çš„è§£æå™¨
from langchain_core.output_parsers import OutputFixingParser

robust_parser = OutputFixingParser.from_llm(
    parser=base_parser,
    llm=ChatOpenAI(model="gpt-4o")
)</code></pre>
                </div>

                <h2>ç›¸å…³ API</h2>
                <ul>
                    <li><a href="prompts.html">Prompts API</a></li>
                    <li><a href="../09-output-parsers.html">æ•™ç¨‹ï¼šè¾“å‡ºè§£æ</a></li>
                </ul>

                <div class="chapter-nav">
                    <a href="checkpointers.html">â† Checkpointers API</a>
                    <a href="document-transformers.html" class="next">Document Transformers API â†’</a>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="../assets/js/main.js"></script>
</body>
</html>
