<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ£€æŸ¥ç‚¹ API - LangChain 1.0</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body class="chapter-api-checkpointers">
    <button class="theme-toggle">ğŸŒ“</button>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>

    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1>LangChain 1.0</h1>
                <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-top: 5px;">API å‚è€ƒ</p>
            </div>
            <div class="sidebar-nav"></div>
        </nav>

        <main class="main-content">
            <div class="content">
                <h1>æ£€æŸ¥ç‚¹ API</h1>
                <p class="subtitle">CheckpointSaver ä¸çŠ¶æ€æŒä¹…åŒ–</p>

                <div class="api-nav">
                    <a href="#overview" class="api-nav-link">æ¦‚è¿°</a>
                    <a href="#base" class="api-nav-link">åŸºç±»</a>
                    <a href="#implementations" class="api-nav-link">å®ç°ç±»</a>
                    <a href="#examples" class="api-nav-link">ç¤ºä¾‹</a>
                </div>

                <h2 id="overview">æ¦‚è¿°</h2>
                <p>æ£€æŸ¥ç‚¹ï¼ˆCheckpointerï¼‰ç”¨äºä¿å­˜å’Œæ¢å¤ LangGraph åº”ç”¨çš„çŠ¶æ€ï¼Œæ”¯æŒæ—¶é—´æ—…è¡Œå’Œæ–­ç‚¹ç»­ä¼ ã€‚</p>

                <pre class="mermaid">graph TD
    A[BaseCheckpointSaver] --> B[MemorySaver]
    A --> C[SqliteSaver]
    A --> D[PostgresCheckpointSaver]
    A --> E[RedisCheckpointSaver]
    A --> F[AzureCheckpointSaver]

    A --> G[ä½¿ç”¨åœºæ™¯]
    G --> H[LangGraph çŠ¶æ€]
    G --> I[å¯¹è¯å†å²]
    G --> J[é•¿æ—¶é—´è¿è¡Œä»»åŠ¡]

    style A fill:#e1f5fe
    style B fill:#c8e6c9</code></pre>

                <h2 id="base">åŸºç±»</h2>

                <div class="api-section">
                    <h3 class="api-title">BaseCheckpointSaver</h3>
                    <p class="api-description">æ£€æŸ¥ç‚¹ä¿å­˜å™¨æŠ½è±¡åŸºç±»ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_core.checkpoint import BaseCheckpointSaver
from langchain_core.runnables import RunnableConfig

class BaseCheckpointSaver(ABC):
    """æ£€æŸ¥ç‚¹ä¿å­˜å™¨åŸºç±»"""

    @abstractmethod
    def get(
        self,
        config: RunnableConfig,
    ) -> Optional[Checkpoint]:
        """
        è·å–æ£€æŸ¥ç‚¹

        Args:
            config: è¿è¡Œé…ç½®ï¼Œéœ€åŒ…å« configurable.thread_id

        Returns:
            æ£€æŸ¥ç‚¹æ•°æ®ï¼ˆå¦‚æœä¸å­˜åœ¨è¿”å› Noneï¼‰
        """

    @abstractmethod
    async def aget(
        self,
        config: RunnableConfig,
    ) -> Optional[Checkpoint]:
        """å¼‚æ­¥è·å–æ£€æŸ¥ç‚¹"""

    @abstractmethod
    def put(
        self,
        config: RunnableConfig,
        checkpoint: Checkpoint,
    ) -> RunnableConfig:
        """
        ä¿å­˜æ£€æŸ¥ç‚¹

        Args:
            config: è¿è¡Œé…ç½®
            checkpoint: æ£€æŸ¥ç‚¹æ•°æ®

        Returns:
            æ›´æ–°åçš„é…ç½®ï¼ˆåŒ…å«æ–°æ£€æŸ¥ç‚¹ IDï¼‰
        """

    @abstractmethod
    async def aput(
        self,
        config: RunnableConfig,
        checkpoint: Checkpoint,
    ) -> RunnableConfig:
        """å¼‚æ­¥ä¿å­˜æ£€æŸ¥ç‚¹"""

    def list(
        self,
        config: Optional[RunnableConfig],
        *,
        limit: int = 10,
        before: Optional[RunnableConfig] = None,
    ) -> Iterator[CheckpointTuple]:
        """
        åˆ—å‡ºæ£€æŸ¥ç‚¹

        Args:
            config: åŸºç¡€é…ç½®
            limit: è¿”å›æ•°é‡é™åˆ¶
            before: åˆ—å‡ºæ­¤é…ç½®ä¹‹å‰çš„æ£€æŸ¥ç‚¹

        Yields:
            æ£€æŸ¥ç‚¹å…ƒç»„ (config, checkpoint)
        """

    async def alist(
        self,
        config: Optional[RunnableConfig],
        *,
        limit: int = 10,
        before: Optional[RunnableConfig] = None,
    ) -> AsyncIterator[CheckpointTuple]:
        """å¼‚æ­¥åˆ—å‡ºæ£€æŸ¥ç‚¹"""

    # å¯é€‰æ–¹æ³•
    def get_tuple(
        self,
        config: RunnableConfig,
    ) -> Optional[CheckpointTuple]:
        """
        è·å–æ£€æŸ¥ç‚¹å…ƒç»„ï¼ˆåŒ…å«çˆ¶æ£€æŸ¥ç‚¹ï¼‰

        Returns:
            (config, checkpoint, metadata, parent_config)
        """</code></pre>
                    </div>

                    <h4>Checkpoint æ•°æ®ç»“æ„</h4>
                    <div class="api-signature">
                        <pre><code class="language-python">from typing import TypedDict

class Checkpoint(TypedDict, total=False):
    """æ£€æŸ¥ç‚¹æ•°æ®"""
    # ç”¨æˆ·å®šä¹‰çš„çŠ¶æ€å­—æ®µ
    # ä¾‹å¦‚: {"messages": [...], "step_count": 5}

class CheckpointMetadata(TypedDict, total=False):
    """æ£€æŸ¥ç‚¹å…ƒæ•°æ®"""
    source: str
    """æ£€æŸ¥ç‚¹æ¥æº"""
    step: int
    """æ­¥éª¤ç¼–å·"""
    writes: List[Any]
    """å†™å…¥è®°å½•"""
    parents: dict
    """çˆ¶æ£€æŸ¥ç‚¹æ˜ å°„"""</code></pre>
                    </div>
                </div>

                <h2 id="implementations">å®ç°ç±»</h2>

                <div class="api-section">
                    <h3 class="api-title">MemorySaver</h3>
                    <p class="api-description">å†…å­˜æ£€æŸ¥ç‚¹ä¿å­˜å™¨ï¼ˆå¼€å‘/æµ‹è¯•ç”¨ï¼‰ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langgraph.checkpoint.memory import MemorySaver

class MemorySaver(BaseCheckpointSaver):
    """å†…å­˜æ£€æŸ¥ç‚¹ä¿å­˜å™¨"""

    storage: Dict[str, Dict[str, Checkpoint]]
    """å­˜å‚¨: {thread_id: {checkpoint_id: checkpoint}}"""

    def __init__(self):
        """åˆå§‹åŒ–ï¼ˆä½¿ç”¨å­—å…¸å­˜å‚¨ï¼‰"""</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langgraph.checkpoint.memory import MemorySaver
from langgraph.graph import StateGraph

# åˆ›å»ºæ£€æŸ¥ç‚¹ä¿å­˜å™¨
memory = MemorySaver()

# ç¼–è¯‘å›¾æ—¶ä¼ å…¥
app = workflow.compile(checkpointer=memory)

# ä½¿ç”¨ï¼ˆæŒ‡å®š thread_idï¼‰
config = {"configurable": {"thread_id": "conversation_123"}}
result = app.invoke({"messages": ["ä½ å¥½"]}, config=config)

# åç»­æ‰§è¡Œä¼šä»æ£€æŸ¥ç‚¹æ¢å¤
result = app.invoke({"messages": ["æˆ‘åˆšæ‰é—®äº†ä»€ä¹ˆï¼Ÿ"]}, config=config)</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">SqliteSaver</h3>
                    <p class="api-description">SQLite æ£€æŸ¥ç‚¹ä¿å­˜å™¨ï¼ˆæœ¬åœ°æŒä¹…åŒ–ï¼‰ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain.checkpoint.sqlite import SqliteSaver

class SqliteSaver(BaseCheckpointSaver):
    """SQLite æ£€æŸ¥ç‚¹ä¿å­˜å™¨"""

    conn: sqlite3.Connection
    """SQLite è¿æ¥"""

    def __init__(
        self,
        conn: Union[str, sqlite3.Connection],
    ):
        """
        åˆå§‹åŒ–

        Args:
            conn: æ•°æ®åº“æ–‡ä»¶è·¯å¾„æˆ–è¿æ¥
        """</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain.checkpoint.sqlite import SqliteSaver

# æ–¹å¼1: ä½¿ç”¨æ–‡ä»¶è·¯å¾„
memory = SqliteSaver.from_conn_string("checkpoints.db")

# æ–¹å¼2: ä½¿ç”¨è¿æ¥
import sqlite3
conn = sqlite3.connect("checkpoints.db")
memory = SqliteSaver(conn)

# ä½¿ç”¨
app = workflow.compile(checkpointer=memory)</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">PostgresCheckpointSaver</h3>
                    <p class="api-description">PostgreSQL æ£€æŸ¥ç‚¹ä¿å­˜å™¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain.checkpoint.postgres import PostgresCheckpointSaver

class PostgresCheckpointSaver(BaseCheckpointSaver):
    """PostgreSQL æ£€æŸ¥ç‚¹ä¿å­˜å™¨"""

    def __init__(
        self,
        conn: Union[str, AsyncConnection],
    ):
        """
        åˆå§‹åŒ–

        Args:
            conn: è¿æ¥å­—ç¬¦ä¸²æˆ–å¼‚æ­¥è¿æ¥
                æ ¼å¼: "postgresql://user:pass@host:port/db"
        """</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain.checkpoint.postgres import PostgresCheckpointSaver

memory = PostgresCheckpointSaver.from_conn_string(
    "postgresql://user:pass@localhost:5432/langchain"
)

app = workflow.compile(checkpointer=memory)</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">RedisCheckpointSaver</h3>
                    <p class="api-description">Redis æ£€æŸ¥ç‚¹ä¿å­˜å™¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain.checkpoint.redis import RedisCheckpointSaver

class RedisCheckpointSaver(BaseCheckpointSaver):
    """Redis æ£€æŸ¥ç‚¹ä¿å­˜å™¨"""

    def __init__(
        self,
        conn: Optional[Redis] = None,
        client_kwargs: Optional[dict] = None,
    ):
        """
        åˆå§‹åŒ–

        Args:
            conn: Redis å®¢æˆ·ç«¯
            client_kwargs: å®¢æˆ·ç«¯å‚æ•°
        """</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain.checkpoint.redis import RedisCheckpointSaver

memory = RedisCheckpointSaver(
    client_kwargs={
        "host": "localhost",
        "port": 6379,
        "db": 0
    }
)

app = workflow.compile(checkpointer=memory)</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">AzureCheckpointSaver</h3>
                    <p class="api-description">Azure Blob Storage æ£€æŸ¥ç‚¹ä¿å­˜å™¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain.checkpoint.azure import AzureCheckpointSaver

class AzureCheckpointSaver(BaseCheckpointSaver):
    """Azure æ£€æŸ¥ç‚¹ä¿å­˜å™¨"""

    def __init__(
        self,
        container_name: str,
        credential: Any,
        blob_name_prefix: str = "",
    ):
        """
        åˆå§‹åŒ–

        Args:
            container_name: å®¹å™¨åç§°
            credential: Azure å‡­æ®
            blob_name_prefix: Blob å‰ç¼€
        """</code></pre>
                    </div>
                </div>

                <h2 id="examples">ä½¿ç”¨ç¤ºä¾‹</h2>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python"># ========== ç¤ºä¾‹1: ä½¿ç”¨ MemorySaver ==========
from langgraph.checkpoint.memory import MemorySaver
from langgraph.graph import StateGraph, END
from typing import TypedDict, Annotated
import operator

class GraphState(TypedDict):
    messages: Annotated[list, operator.add]
    step_count: int

def node_a(state: GraphState):
    return {"messages": ["A æ‰§è¡Œ"], "step_count": state.get("step_count", 0) + 1}

# æ„å»ºå›¾
workflow = StateGraph(GraphState)
workflow.add_node("node_a", node_a)
workflow.set_entry_point("node_a")
workflow.add_edge("node_a", END)

# ä½¿ç”¨æ£€æŸ¥ç‚¹
memory = MemorySaver()
app = workflow.compile(checkpointer=memory)

# æ‰§è¡Œï¼ˆæŒ‡å®š thread_idï¼‰
config = {"configurable": {"thread_id": "thread_1"}}
result = app.invoke({"messages": [], "step_count": 0}, config=config)
print(f"Step count: {result['step_count']}")  # 1

# ç¬¬äºŒæ¬¡æ‰§è¡Œï¼ˆçŠ¶æ€ä¼šä¿ç•™ï¼‰
result = app.invoke({"messages": ["ç»§ç»­"]}, config=config)
print(f"Step count: {result['step_count']}")  # 2

# ========== ç¤ºä¾‹2: æŸ¥çœ‹å†å²çŠ¶æ€ ==========
state_history = app.get_state(config)
print(f"å½“å‰çŠ¶æ€: {state_history.values}")

# åˆ—å‡ºæ‰€æœ‰æ£€æŸ¥ç‚¹
for checkpoint in app.list(config):
    print(f"Checkpoint: {checkpoint}")

# ========== ç¤ºä¾‹3: æ—¶é—´æ—…è¡Œ ==========
# å›åˆ°ä¹‹å‰çš„æ£€æŸ¥ç‚¹
checkpoint_list = list(app.list(config))
if len(checkpoint_list) > 1:
    # è·å–å‰ä¸€ä¸ªæ£€æŸ¥ç‚¹
    prev_checkpoint = checkpoint_list[-2]
    # ä»è¯¥ç‚¹é‡æ–°æ‰§è¡Œ
    app.replay(prev_checkpoint.config)

# ========== ç¤ºä¾‹4: ä½¿ç”¨ SqliteSaver ==========
from langchain.checkpoint.sqlite import SqliteSaver

memory = SqliteSaver.from_conn_string("checkpoints.db")
app = workflow.compile(checkpointer=memory)

# ========== ç¤ºä¾‹5: å¤šçº¿ç¨‹éš”ç¦» ==========
# ä¸åŒ thread_id çš„çŠ¶æ€æ˜¯éš”ç¦»çš„
config1 = {"configurable": {"thread_id": "user_123"}}
config2 = {"configurable": {"thread_id": "user_456"}}

result1 = app.invoke({"messages": ["ç”¨æˆ·1æ¶ˆæ¯"]}, config=config1)
result2 = app.invoke({"messages": ["ç”¨æˆ·2æ¶ˆæ¯"]}, config=config2)

# ä¸¤ä¸ªçº¿ç¨‹çš„çŠ¶æ€ç‹¬ç«‹

# ========== ç¤ºä¾‹6: ä¸ RunnableWithMessageHistory ç»“åˆ ==========
from langchain_core.runnables.history import RunnableWithMessageHistory

# ä½¿ç”¨ MemorySaver ä½œä¸ºå†å²å­˜å‚¨
from langgraph.checkpoint.memory import MemorySaver

def get_history(session_id: str):
    # è¿”å›è¯¥ session çš„æ£€æŸ¥ç‚¹
    return MemorySaver()

with_history = RunnableWithMessageHistory(
    chain,
    get_history,
    input_messages_key="input",
    history_messages_key="history"
)</code></pre>
                </div>

                <h2>ç›¸å…³ API</h2>
                <ul>
                    <li><a href="memory.html">Memory API</a></li>
                    <li><a href="langgraph.html">LangGraph API</a></li>
                    <li><a href="../17-langgraph.html">æ•™ç¨‹ï¼šå›¾å·¥ä½œæµ</a></li>
                </ul>

                <div class="chapter-nav">
                    <a href="memory.html">â† Memory API</a>
                    <a href="output-parsers.html" class="next">Output Parsers API â†’</a>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="../assets/js/main.js"></script>
</body>
</html>
