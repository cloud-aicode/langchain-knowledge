<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›è°ƒ API - LangChain 1.0</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body class="chapter-api-callbacks">
    <button class="theme-toggle">ğŸŒ“</button>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>

    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1><a href="../index.html" style="color: white; text-decoration: none;">LangChain 1.0</a></h1>
                <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-top: 5px;">API å‚è€ƒ</p>
            </div>
            <div class="sidebar-nav"></div>
        </nav>

        <main class="main-content">
            <div class="content">
                <h1>å›è°ƒ API</h1>
                <p class="subtitle">BaseCallbackHandler ä¸äº‹ä»¶å¤„ç†</p>

                <div class="api-nav">
                    <a href="#overview" class="api-nav-link">æ¦‚è¿°</a>
                    <a href="#base" class="api-nav-link">åŸºç±»</a>
                    <a href="#handlers" class="api-nav-link">å†…ç½®å¤„ç†å™¨</a>
                    <a href="#examples" class="api-nav-link">ç¤ºä¾‹</a>
                </div>

                <h2 id="overview">æ¦‚è¿°</h2>
                <p>å›è°ƒç³»ç»Ÿå…è®¸ä½ åœ¨ LangChain è¿è¡Œçš„å„ä¸ªé˜¶æ®µæ’å…¥è‡ªå®šä¹‰é€»è¾‘ï¼Œç”¨äºæ—¥å¿—ã€ç›‘æ§ã€è°ƒè¯•ç­‰ã€‚</p>

                <pre class="mermaid">graph TD
    A[BaseCallbackHandler] --> B[AimessageCallbackHandler]
    A --> C[StdOutCallbackHandler]
    A --> D[TokenCallbackHandler]
    A --> E[FileCallbackHandler]

    A --> F[è‡ªå®šä¹‰ Handler]
    F --> G[æ—¥å¿—è®°å½•]
    F --> H[æ€§èƒ½ç›‘æ§]
    F --> I[è‡ªå®šä¹‰é€»è¾‘]

    style A fill:#e1f5fe
    style F fill:#c8e6c9</code></pre>

                <h2 id="base">åŸºç±»</h2>

                <div class="api-section">
                    <h3 class="api-title">BaseCallbackHandler</h3>
                    <p class="api-description">å›è°ƒå¤„ç†å™¨æŠ½è±¡åŸºç±»ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain_core.callbacks import BaseCallbackHandler

class BaseCallbackHandler:
    """å›è°ƒå¤„ç†å™¨åŸºç±»"""

    # ========== è¿è¡Œå¼€å§‹/ç»“æŸ ==========

    def on_llm_start(
        self,
        serialized: Dict[str, Any],
        prompts: List[str],
        **kwargs: Any,
    ) -> Any:
        """
        LLM å¼€å§‹æ—¶è°ƒç”¨

        Args:
            serialized: æ¨¡å‹çš„åºåˆ—åŒ–ä¿¡æ¯
            prompts: è¾“å…¥æç¤ºåˆ—è¡¨
            **kwargs: é¢å¤–å‚æ•°
        """

    def on_llm_end(
        self,
        response: LLMResult,
        **kwargs: Any,
    ) -> Any:
        """
        LLM ç»“æŸæ—¶è°ƒç”¨

        Args:
            response: LLM å“åº”ç»“æœ
            **kwargs: é¢å¤–å‚æ•°
        """

    def on_llm_error(
        self,
        error: Exception,
        **kwargs: Any,
    ) -> Any:
        """
        LLM å‡ºé”™æ—¶è°ƒç”¨

        Args:
            error: å¼‚å¸¸å¯¹è±¡
            **kwargs: é¢å¤–å‚æ•°
        """

    def on_llm_new_token(
        self,
        token: str,
        **kwargs: Any,
    ) -> Any:
        """
        æ–° token ç”Ÿæˆæ—¶è°ƒç”¨ï¼ˆæµå¼ï¼‰

        Args:
            token: æ–°ç”Ÿæˆçš„ token
            **kwargs: é¢å¤–å‚æ•°
        """

    # ========== Chain äº‹ä»¶ ==========

    def on_chain_start(
        self,
        serialized: Dict[str, Any],
        inputs: Dict[str, Any],
        **kwargs: Any,
    ) -> Any:
        """Chain å¼€å§‹æ—¶è°ƒç”¨"""

    def on_chain_end(
        self,
        outputs: Dict[str, Any],
        **kwargs: Any,
    ) -> Any:
        """Chain ç»“æŸæ—¶è°ƒç”¨"""

    def on_chain_error(
        self,
        error: Exception,
        **kwargs: Any,
    ) -> Any:
        """Chain å‡ºé”™æ—¶è°ƒç”¨"""

    # ========== Tool äº‹ä»¶ ==========

    def on_tool_start(
        self,
        serialized: Dict[str, Any],
        input_str: str,
        **kwargs: Any,
    ) -> Any:
        """å·¥å…·å¼€å§‹æ—¶è°ƒç”¨"""

    def on_tool_end(
        self,
        output: str,
        **kwargs: Any,
    ) -> Any:
        """å·¥å…·ç»“æŸæ—¶è°ƒç”¨"""

    def on_tool_error(
        self,
        error: Exception,
        **kwargs: Any,
    ) -> Any:
        """å·¥å…·å‡ºé”™æ—¶è°ƒç”¨"""

    # ========== Agent äº‹ä»¶ ==========

    def on_agent_action(
        self,
        action: AgentAction,
        **kwargs: Any,
    ) -> Any:
        """Agent æ‰§è¡ŒåŠ¨ä½œæ—¶è°ƒç”¨"""

    def on_agent_finish(
        self,
        finish: AgentFinish,
        **kwargs: Any,
    ) -> Any:
        """Agent å®Œæˆæ—¶è°ƒç”¨"""

    # ========== Retriever äº‹ä»¶ ==========

    def on_retriever_start(
        self,
        query: str,
        **kwargs: Any,
    ) -> Any:
        """æ£€ç´¢å™¨å¼€å§‹æ—¶è°ƒç”¨"""

    def on_retriever_end(
        self,
        documents: List[Document],
        **kwargs: Any,
    ) -> Any:
        """æ£€ç´¢å™¨ç»“æŸæ—¶è°ƒç”¨"""

    def on_retriever_error(
        self,
        error: Exception,
        **kwargs: Any,
    ) -> Any:
        """æ£€ç´¢å™¨å‡ºé”™æ—¶è°ƒç”¨"""

    # ========== èŠç‚¹äº‹ä»¶ ==========

    def on_custom_event(
        self,
        name: str,
        data: Any,
        run_id: UUID,
        tags: List[str],
        **kwargs: Any,
    ) -> Any:
        """
        è‡ªå®šä¹‰äº‹ä»¶æ—¶è°ƒç”¨

        Args:
            name: äº‹ä»¶åç§°
            data: äº‹ä»¶æ•°æ®
            run_id: è¿è¡Œ ID
            tags: æ ‡ç­¾åˆ—è¡¨
            **kwargs: é¢å¤–å‚æ•°
        """

    # ========== å±æ€§ ==========

    @property
    def ignore_llm(self) -> bool:
        """æ˜¯å¦å¿½ç•¥ LLM äº‹ä»¶"""

    @property
    def ignore_chain(self) -> bool:
        """æ˜¯å¦å¿½ç•¥ Chain äº‹ä»¶"""

    @property
    def ignore_agent(self) -> bool:
        """æ˜¯å¦å¿½ç•¥ Agent äº‹ä»¶"""

    @property
    def ignore_retriever(self) -> bool:
        """æ˜¯å¦å¿½ç•¥ Retriever äº‹ä»¶"""

    @property
    def raise_error(self) -> bool:
        """æ˜¯å¦åœ¨é”™è¯¯æ—¶æŠ›å‡ºå¼‚å¸¸"""</code></pre>
                    </div>
                </div>

                <h2 id="handlers">å†…ç½®å¤„ç†å™¨</h2>

                <div class="api-section">
                    <h3 class="api-title">StdOutCallbackHandler</h3>
                    <p class="api-description">æ ‡å‡†è¾“å‡ºå›è°ƒå¤„ç†å™¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain.callbacks import StdOutCallbackHandler

class StdOutCallbackHandler(BaseCallbackHandler):
    """æ ‡å‡†è¾“å‡ºå›è°ƒå¤„ç†å™¨"""

    def __init__(
        self,
        color: Optional[str] = None,
    ):
        """
        åˆå§‹åŒ–

        Args:
            color: è¾“å‡ºé¢œè‰²ï¼ˆæ”¯æŒç»ˆç«¯é¢œè‰²ä»£ç ï¼‰
        """</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain.callbacks import StdOutCallbackHandler
from langchain_openai import ChatOpenAI

handler = StdOutCallbackHandler()

llm = ChatOpenAI(model="gpt-4o")
response = llm.invoke(
    "ä½ å¥½",
    config={"callbacks": [handler]}
)

# è¾“å‡º:
# [chain/start] Entering Chain run with input: 'hello'
# [llm/start] Entering LLM run with input: 'hello'
# [llm/end] Finished LLM.
# [chain/end] Finished Chain.</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">TokenCallbackHandler</h3>
                    <p class="api-description">Token è®¡æ•°å›è°ƒå¤„ç†å™¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain.callbacks import TokenCallbackHandler

class TokenCallbackHandler(BaseCallbackHandler):
    """Token è®¡æ•°å›è°ƒå¤„ç†å™¨"""

    def __init__(self):
        self.total_tokens = 0
        self.prompt_tokens = 0
        self.completion_tokens = 0

    def on_llm_end(self, response, **kwargs):
        """è®°å½• token ä½¿ç”¨"""
        self.total_tokens = response.llm_output["token_usage"]["total_tokens"]
        self.prompt_tokens = response.llm_output["token_usage"]["prompt_tokens"]
        self.completion_tokens = response.llm_output["token_usage"]["completion_tokens"]</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain.callbacks import TokenCallbackHandler

token_handler = TokenCallbackHandler()

llm.invoke(
    "å†™ä¸€é¦–è¯—",
    config={"callbacks": [token_handler]}
)

print(f"æ€» tokens: {token_handler.total_tokens}")
print(f"è¾“å…¥ tokens: {token_handler.prompt_tokens}")
print(f"è¾“å‡º tokens: {token_handler.completion_tokens}")</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">FileCallbackHandler</h3>
                    <p class="api-description">æ–‡ä»¶è¾“å‡ºå›è°ƒå¤„ç†å™¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain.callbacks import FileCallbackHandler

class FileCallbackHandler(BaseCallbackHandler):
    """æ–‡ä»¶å›è°ƒå¤„ç†å™¨"""

    def __init__(
        self,
        filename: str,
        mode: str = "a",
    ):
        """
        åˆå§‹åŒ–

        Args:
            filename: è¾“å‡ºæ–‡ä»¶å
            mode: æ–‡ä»¶æ‰“å¼€æ¨¡å¼
        """</code></pre>
                    </div>

                    <h4>ä½¿ç”¨ç¤ºä¾‹</h4>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-language">python</span>
                            <button class="copy-btn">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-python">from langchain.callbacks import FileCallbackHandler

handler = FileCallbackHandler("langchain.log")

llm.invoke(
    "ä½ å¥½",
    config={"callbacks": [handler]}
)
# å†™å…¥åˆ° langchain.log</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">StreamingStdOutCallbackHandler</h3>
                    <p class="api-description">æµå¼æ ‡å‡†è¾“å‡ºå¤„ç†å™¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain.callbacks.streaming_stdout import StreamingStdOutCallbackHandler

handler = StreamingStdOutCallbackHandler()

# æµå¼è¾“å‡º
for chunk in llm.stream("è®²ä¸€ä¸ªæ•…äº‹", config={"callbacks": [handler]}):
    pass</code></pre>
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="api-title">VerboseCallbackHandler</h3>
                    <p class="api-description">è¯¦ç»†è¾“å‡ºå›è°ƒå¤„ç†å™¨ã€‚</p>

                    <div class="api-signature">
                        <pre><code class="language-python">from langchain.callbacks import verbose

# ä½¿ç”¨ verbose å‚æ•°
chain.invoke(input, verbose=True)</code></pre>
                    </div>
                </div>

                <h2 id="examples">ä½¿ç”¨ç¤ºä¾‹</h2>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">python</span>
                        <button class="copy-btn">å¤åˆ¶</button>
                    </div>
                    <pre><code class="language-python"># ========== ç¤ºä¾‹1: è‡ªå®šä¹‰å›è°ƒå¤„ç†å™¨ ==========
from langchain_core.callbacks import BaseCallbackHandler

class MyCallbackHandler(BaseCallbackHandler):
    def on_llm_start(self, serialized, prompts, **kwargs):
        print(f"LLM å¼€å§‹ï¼Œæç¤º: {prompts[0][:50]}...")

    def on_llm_end(self, response, **kwargs):
        print(f"LLM ç»“æŸ")
        if hasattr(response, "llm_output"):
            token_usage = response.llm_output.get("token_usage", {})
            print(f"Token ä½¿ç”¨: {token_usage}")

    def on_llm_error(self, error, **kwargs):
        print(f"LLM é”™è¯¯: {error}")

handler = MyCallbackHandler()
llm.invoke("ä½ å¥½", config={"callbacks": [handler]})

# ========== ç¤ºä¾‹2: å¤šä¸ªå›è°ƒ ==========
from langchain.callbacks import StdOutCallbackHandler, FileCallbackHandler

handlers = [
    StdOutCallbackHandler(),
    FileCallbackHandler("output.log")
]

llm.invoke("ä½ å¥½", config={"callbacks": handlers})

# ========== ç¤ºä¾‹3: åœ¨é“¾ä¸­ä½¿ç”¨ ==========
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.runnables import RunnablePassthrough

class TimingCallback(BaseCallbackHandler):
    import time
    def __init__(self):
        self.start_time = None

    def on_chain_start(self, serialized, inputs, **kwargs):
        self.start_time = self.time.time()

    def on_chain_end(self, outputs, **kwargs):
        duration = self.time.time() - self.start_time
        print(f"Chain è€—æ—¶: {duration:.2f}s")

timing = TimingCallback()
chain = prompt | llm
result = chain.invoke({"input": "ä½ å¥½"}, config={"callbacks": [timing]})

# ========== ç¤ºä¾‹4: å…¨å±€å›è°ƒ ==========
import os
from langchain.globals import set_debug

set_debug(True)  # å¯ç”¨å…¨å±€è°ƒè¯•ï¼ˆæ‰€æœ‰è¿è¡Œéƒ½ä¼šæ‰“å°ï¼‰

# ========== ç¤ºä¾‹5: å›è°ƒç®¡ç†å™¨ ==========
from langchain_core.callbacks import CallbackManager

manager = CallbackManager(handlers=[handler1, handler2])
config = {"callbacks": manager}</code></pre>
                </div>

                <h2>ç›¸å…³ API</h2>
                <ul>
                    <li><a href="tracers.html">Tracers API</a></li>
                    <li><a href="../13-callbacks.html">æ•™ç¨‹ï¼šå›è°ƒç³»ç»Ÿ</a></li>
                </ul>

                <div class="chapter-nav">
                    <a href="document-transformers.html">â† Document Transformers API</a>
                    <a href="tracers.html" class="next">Tracers API â†’</a>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="../assets/js/main.js"></script>
</body>
</html>
